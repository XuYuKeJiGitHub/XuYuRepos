package com.xuyurepos.serviceImpl.manager;

import java.util.List;

import javax.annotation.Resource;

import org.apache.log4j.Logger;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.xuyurepos.common.log.LoggerFactory;
import com.xuyurepos.dao.manager.ImportTempDao;
import com.xuyurepos.dao.manager.XuyuContentCardInfoDao;
import com.xuyurepos.entity.system.SystemAnnexe;
import com.xuyurepos.service.manager.ImportTempService;
import com.xuyurepos.service.system.SystemAnnexeService;
/**
 * 临时表处理
 * @author yangfei
 *
 */
@Transactional
@Service
public class ImportTempServiceImpl implements ImportTempService{
	Logger logger=LoggerFactory.getInstance().getLogger(ImportTempServiceImpl.class);

	@Resource
	private ImportTempExcelParse importTempExcelParse;
	@Resource
	private SystemAnnexeService systemAnnexeService;
	@Resource
	private ImportTempDao importTempDao;
	@Resource
	private XuyuContentCardInfoDao xuyuContentCardInfoDao;
	
	/**
	 * 解析数据入库
	 */
	@Override
	public void anaLysisData(String batchNo) {
//		String fileName="C:\\Users\\yangfei\\Desktop\\旭宇科技\\test2.xlsx";
		if(batchNo==null||"".equals(batchNo)){
			logger.error("解析异常：没有正确传入参数");
		}else{
			SystemAnnexe annexe=new SystemAnnexe();
			annexe.setUploadBatchno(batchNo);
			List<SystemAnnexe> list=systemAnnexeService.getList(annexe);
			if(list.size()>0){
				for (int i = 0; i < list.size(); i++) {
					annexe=list.get(i);
					logger.info("解析数据目录");
					importTempExcelParse.anaLysisData(annexe.getUploadPath());
				}
				
				// 解析完成后操作
				// 第一步删除无效数据
				importTempDao.del();
				// 第二部分数据校验
				int i=importTempDao.getCount();
				if(i==0){
					// 目标表没数据，直接插入表数据
					xuyuContentCardInfoDao.insert(batchNo);
					
				}else{
					// 插入日志表
					System.out.println("没有插入的数据");
				}
			}
			
		}
		
	}

}
