<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>在线充值系统</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet"  href="layui/css/layui.css"  media="all">
  <link rel="stylesheet"  href="css.css"  media="all">
  <link rel="stylesheet"  href="index.css"  media="all">
  <script src="layui/layui.all.js" charset="utf-8"></script>
</head>
 <legend  class="alignCenter">流量在线充值系统</legend>
 
<div class="layui-tab">
  <ul class="layui-tab-title alignCenter">
    <li>公告</li>
    <li class="layui-this">在线充值</li>
    <li>流量查询</li>
    <li>实名认证</li>
  </ul>
  <div class="layui-tab-content">
    <div class="layui-tab-item">
    </div>
    
    
    <div class="layui-tab-item layui-show">
      <div style="overflow:scroll;height:100%;position:absolute;width:100%;">
      
	      <div class="m20 recharge">
					<br>
					<div class="list">
						<label class="item item-input item-stacked-label waves-effect">
							  <div class="layui-inline">
								  <input id="accessNums" type="text" ng-model="recharge.Entity.FlowCardNo" placeholder="请输入流量卡号/手机号">
							  </div>  
							  <button id="accessNumBut" style="float: right;" class="layui-btn layui-btn-primary layui-btn-small layui-btn-radius">确认</button>
							
						</label>
						
						<div id="ycdiv" class="item item-input item-select waves-effect" style="margin-top: 20px;">
							<div class="input-label">是否预充值</div>
							<select id="yc" class="ng-pristine ng-untouched ng-valid">
							    <optgroup label="选择否,会直接清空当前流量,并且生效">
							    <option value="n">否</option>
							    </optgroup>
							    <optgroup label="选择是,则当前充值暂不生效,到期后开始生效">
							    <option value="y">是</option>
							    </optgroup>
							</select>
					    </div>
						
						<div id="monthDiv" style="margin-left: 10px;margin-top: 10px;display:inline-table ;float: left;">
						    <div style="float: left;">
						        <h4>流量月包</h4>
						    </div>
						    <div  style="float: left;color: gray;margin-top: 10px;margin-left: 5px;">原套餐未使用完，再次充值原套餐会清零</div>
						    
						    <div class="packageList">
						   
					        </div>
						</div>
						
					   
					   <div id="yearDiv" style="margin-left: 10px;margin-top: 30px;">
						    <div style="float: left;">
						        <h4>流量年包</h4>
						    </div>
						    <div  style="float: left;color: gray;margin-top: 10px;margin-left: 5px;">原套餐未使用完，再次充值原套餐会清零</div>
						    
						    <div class="packageList">
						    </div>
						    
						</div>
						
					   
					   <div id="jyDiv" style="margin-left: 10px;margin-top: 30px;">
						    <div style="float: left;">
						        <h4>加油包</h4>
						    </div>
						    <div  style="float: left;color: gray;margin-top: 10px;margin-left: 5px;">到帐后生效，当月有效</div>
						    
						    <div class="packageList">
						    </div>
						</div>
				  </div>
		  </div>
		  <div style="height:100px;border:0px solid red;margin-bottom: 10px;">
		  </div>
      </div>
    </div>
    
    
    <div class="layui-tab-item">
        <div class="scroll">
	<div class="m20 query">
	<div class="list">
		<label class="item item-input item-stacked-label waves-effect">
			<span class="input-label">流量卡号</span>
			<input type="text" id="keywordsQuery" placeholder="请输入流量卡号/手机号" class="ng-pristine ng-untouched ng-valid ng-empty">
		</label>
		<button class="button button-block button-assertive waves-effect" onclick="queryFlow()">查询</button>
	</div>
	
	<div class="layui-tab-flow" id="layui-tab-flow">

			<div class="list">
				<label class="item item-input item-stacked-label waves-effect">
					<span class="input-label" >流量卡号</span>
					<input type="text" id="h-iccid" class="ng-pristine ng-untouched ng-valid ng-empty">
				</label>
				<label class="item item-input item-stacked-label waves-effect">
					<span class="input-label">运营商</span>
					<input type="text" id="h-oper"  class="ng-pristine ng-valid ng-empty ng-touched" >
				</label>
				<label class="item item-input item-stacked-label waves-effect">
					<span class="input-label">套餐类型</span>
					<input type="text" id="h-type" ng-model="authen.Entity.Mobile" class="ng-pristine ng-untouched ng-valid ng-empty" style="">
				</label>
				<label class="item item-input item-stacked-label waves-effect">
					<span class="input-label">套餐</span>
					<input type="text" id="h-conpu" class="ng-pristine ng-untouched ng-valid ng-empty" style="">
				</label>
				<label class="item item-input item-stacked-label waves-effect">
					<span class="input-label">到期时间</span>
					<input type="text" id="h-deadLineDate" class="ng-pristine ng-untouched ng-valid ng-empty" style="">
				</label>
				<label class="item item-input item-stacked-label waves-effect">
					<span class="input-label">套餐总量</span>
					<input type="text" id="h-total" class="ng-pristine ng-untouched ng-valid ng-empty" style="">
				</label>
				<label class="item item-input item-stacked-label waves-effect">
					<span class="input-label">余额</span>
					<input type="text" id="h-yuer" class="ng-pristine ng-untouched ng-valid ng-empty" style="">
				</label>
			</div>
	</div>
		
	</div>
</div>
</div>
    

    <div class="layui-tab-item">
        
        <div class="list">
	<label class="item item-input item-stacked-label waves-effect">
		<span class="input-label" >流量卡号</span>
		<input type="text" placeholder="请输入卡号码" class="ng-pristine ng-untouched ng-valid ng-empty">
	</label>
	<br>
	<label class="item item-input item-stacked-label waves-effect">
		<span class="input-label">姓名</span>
		<input type="text" placeholder="您的真实姓名" class="ng-pristine ng-valid ng-empty ng-touched" >
	</label>
		<br>
	<label class="item item-input item-stacked-label waves-effect">
		<span class="input-label">手机号码</span>
		<input type="text" placeholder="联系手机号码" ng-model="authen.Entity.Mobile" class="ng-pristine ng-untouched ng-valid ng-empty" style="">
	</label>
		<br>
	<label class="item item-input item-stacked-label waves-effect">
		<span class="input-label">身份证号</span>
		<input type="text" placeholder="您的身份证号" class="ng-pristine ng-untouched ng-valid ng-empty" style="">
	</label>
		<br>
	<div class="item item-input item-stacked-label">
		<a href="javascript:;" class="a-upload ng-binding">
			<input type="file" class="button button-full button-positive" nv-file-select="" uploader="authen.uploader" multiple="">上传身份证正、反面，手持身份证（0/3）</a>
	</div>
	<button class="button button-block button-assertive waves-effect">提交认证资料</button>
	</div>
    </div>
  </div>
</div>

<div id="add-main" style="padding: 3px; background-color: #F2F2F2;">
		  <div class="layui-card alignCenter" >
	           <div id="alipay" class="layui-card-body" style="color: blue;"><img src="image/alipay.jpg"></img></div>
	           <div id="wxpay" class="layui-card-body" style="color: blue;"><img src="image/wx.png"></img></div>
	           <div id="cancle" class="layui-card-body" style="color: blue;">取消支付</div>
         </div>
</div> 

<script src="../js/jquery.min-1.12.4.js"></script>
<script type="text/javascript">

$.getUrlParam = function (name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
    var r = window.location.search.substr(1).match(reg);
    if (r != null) return unescape(r[2]); return null;
}
/**
 * 关闭
 */
function custom_close(){
	var userAgent = navigator.userAgent; 
	if (userAgent.indexOf("Chrome") > -1) {
		window.location.href = "about:blank";                    //关键是这句话
        window.close();
	}else if(userAgent.indexOf('Android') > -1 || userAgent.indexOf('Linux') > -1){
        window.history.back();
        window.close();
    }else if (userAgent.indexOf("Safari") > -1) {
    	window.location.href = "about:blank";                    //关键是这句话
        window.close();
    }else{
		window.opener=null;
		window.open(' ','_self');
		window.close();
	}
}

function reload(type){
    var id=$.getUrlParam("id");
    if(id==null){
    	layer.msg('非法参数');
    	custom_close();
    }else{
    	var comeon=$('#comeon').val();
    	var tcyl=$('#tcyl').val();
	   	 $.ajax({            
	         type:"POST",   //post提交方式默认是get
	         url:'/XuYuRepos/xuyupackages/views',
	         type:"POST",   //post提交方式默认是get
	         data : {
	        	 id : id,
	        	 type:tcyl,
	        	 comeon:comeon
	         },
	         success:function(data){
	        	$("div[class=packageList]").html("");
	        	var dataDiv="";
	        	for (var int = 0; int < data.total; int++) {
	        		/**
	        		if(data.rows[int].gprs>=1024){
	        			dataDiv=dataDiv+'<a class="packageItem"><input type="hidden" value="'+data.rows[int].id+'"/><font class="ng-binding" style="font-size:18px;">'+data.rows[int].gprs/1024+'GB/'+data.rows[int].availableName+'</font><h2 class="ng-binding" style="font-size:18px;">￥'+data.rows[int].selfPrice+'</h2></a>';
	        		}else{
	        			dataDiv=dataDiv+'<a class="packageItem"><input type="hidden" value="'+data.rows[int].id+'"/><font class="ng-binding" style="font-size:18px;">'+data.rows[int].gprs+'MB/'+data.rows[int].availableName+'</font><h2 class="ng-binding" style="font-size:18px;">￥'+data.rows[int].selfPrice+'</h2></a>';
	        		}*/
	        		dataDiv=dataDiv+'<a class="packageItem"><input type="hidden" value="'+data.rows[int].id+'"/><font class="ng-binding" style="font-size:18px;">'+data.rows[int].desc+'</font><h2 class="ng-binding" style="font-size:18px;">￥'+data.rows[int].selfPrice+'</h2></a>';
				}
	        	$("div[class=packageList]").append(dataDiv);
			 },
			 error:function(rep){ss
				 layer.msg('错误');
			 }
	      });
    }
};



(function ($) {
    $("#add-main").hide();
    $("#layui-tab-flow").hide();
	
    var payId="";
	$(document).on("click","a[class=packageItem]",function(){
		payId=$(this).find('input[type=hidden]').val();
		//页面层-自定义
	    layer.open({
	        type: 1,
	        title:"请选择支付方式",
	        closeBtn: false,
	        shift: 2,
	        area: ['100%', '220px'],
	        offset: 'b',
	        shadeClose: false,
	        content: $("#add-main"),
	        success: function(layero, index){}
	    });
	});
	
	$('#alipay').click(function(){
		// 首先生成订单
		var id=$.getUrlParam("id");
		var accessNums=$("#accessNums").val();
		if(accessNums==''){
			layer.msg('请输入充值账号');
		}else{
			// 检验数字有效性
			 $.ajax({            
		         type:"POST",   //post提交方式默认是get
		         data : {
		        	 accessNums : accessNums
		         },
		         url:'/XuYuRepos/alipay/checkNums',
		         success:function(data){
                	if(data.sucess!=undefined&&data.sucess==false){
                		layer.msg(data.msg);
                	}else{
                		if(data.result==true){
                			// 生成订单
                			$.ajax({            
                		         type:"POST",   //post提交方式默认是get
                		         data : {
                		        	 accessNums : data.accessNum,
                		        	 id:id,
                		        	 payId:payId,
                		        	 yc:yc
                		         },
                		         url:'/XuYuRepos/alipay/createOrder',
                		         success:function(data){
                		        	 if(data.sucess!=undefined&&data.sucess==false){
                		        		 layer.msg(data.msg);
                		        	 }else{
                		        		 location.href="../wappay/pay.jsp?cardNo="+data.order.id+"&WIDtotal_amount="+data.order.money;
                		        	 }
                				 },
                				 error:function(rep){
                					 layer.msg('订单生成错误，请稍候再试');
                				 }
                		    });
                		}else{
                			layer.msg('充值账号错误');
                		}
                	}
				 },
				 error:function(rep){
					layer.msg('充值账号错误');
				 }
		      });
		}
	});
	
	$('#wxpay').click(function(){
		// 首先生成订单
		var id=$.getUrlParam("id");
		var accessNums=$("#accessNums").val();
		if(accessNums==''){
			layer.msg('请输入充值账号');
		}else{
			// 检验数字有效性
			 $.ajax({            
		         type:"POST",   //post提交方式默认是get
		         data : {
		        	 accessNums : accessNums
		         },
		         url:'/XuYuRepos/alipay/checkNums',
		         success:function(data){
                	if(data.sucess!=undefined&&data.sucess==false){
                		layer.msg(data.msg);
                	}else{
                		if(data.result==true){
                			var yc=$('#yc').val();
                			// 生成订单
                			$.ajax({            
                		         type:"POST",   //post提交方式默认是get
                		         data : {
                		        	 accessNums : data.accessNum,
                		        	 id:id,
                		        	 payId:payId,
                		        	 yc:yc
                		         },
                		         url:'/XuYuRepos/alipay/createOrder',
                		         success:function(data){
                		        	 if(data.sucess!=undefined&&data.sucess==false){
               	                		layer.msg(data.msg);
               	                	 }else{
               	                	     // 判断是否为微信内支付
                    		        	 if (/MicroMessenger/.test(window.navigator.userAgent)) {
                    		        		 sessionStorage.setItem('out_trade_no',data.order.id);
                    		        		 sessionStorage.setItem('money',data.order.money);
                    		        		 location.href="/XuYuRepos/wxpay/openIdRedirect";
                    		        	 }else{
                    		        		 if(data.sucess!=undefined&&data.sucess==false){
                        		        		 layer.msg(data.msg);
                        		        	 }else{
                        		        		 // 直接扫码支付
                        		        		 $.ajax({            
        			                		         type:"POST",   //post提交方式默认是get
        			                		         data : {
        			                		        	 totalFee : data.order.money,
        			                		        	 tradeType:'NATIVE',
        			                		        	 out_trade_no:data.order.id
        			                		         },
        			                		         url:'/XuYuRepos/wxpay/pay',
        			                		         success:function(data){
        			                		        	 location.href="paynative.html?code_url="+data.code_url;
        			                		         }
                        		        	    });
                        		        	 }
                    		        	 }
               	                	 }
                				 },
                				 error:function(rep){
                					 layer.msg('订单生成错误，请稍候再试');
                				 }
                		    });
                		}else{
                			layer.msg('充值账号错误');
                		}
                	}
				 },
				 error:function(rep){
					layer.msg('充值账号错误');
				 }
		      });
		}
	});
	
	$('#cancle').click(function(){
		layer.closeAll();
		$("#add-main").hide();
	});
	
	
	$('#accessNumBut').click(function(){
		var accessNums=$("#accessNums").val();
		if(accessNums==''){
			 layer.msg('请输入充值账号');
		}else{
			 $.ajax({            
		         type:"POST",   //post提交方式默认是get
		         data : {
		        	 accessNums : accessNums
		         },
		         url:'/XuYuRepos/alipay/checkNums',
		         success:function(data){
		        	 // 获取当前运营商的类别
		        	 if(data.result==true){
		        		 var id=$.getUrlParam("id");
		        		 
		        		 $("#ycdiv").show();
		        		 
                		 // 加载月份充值数据
		        	  	 $.ajax({            
		        	         type:"POST",   //post提交方式默认是get
		        	         url:'/XuYuRepos/xuyupackages/views',
		        	         type:"POST",   //post提交方式默认是get
		        	         data : {
		        	        	 id : id,
		        	        	 type: data.provider+";1",
		        	        	 comeon:'n'
		        	         },
		        	         success:function(data){
		        	        	 if(data.total>0){
		        	        		 $("#monthDiv").find("div[class=packageList]").html("");
			        		        	var dataDiv="";
			        		        	for (var int = 0; int < data.total; int++) {
			        		        		var taocan=data.rows[int].desc;
			        		        		var money=data.rows[int].selfPrice.toFixed(2)+'元';
			        		        		dataDiv=dataDiv+'<a class="packageItem" style="margin-left: 5px;"><input type="hidden" value="'+data.rows[int].id+'"/>'
											+'<h2 style="font-size:18px;margin-top: 10px;margin-bottom: 0px;">'+taocan+'</h2>'
											+'<h2 style="font-size:0.8rem;margin-top: 0px;margin-bottom: 10px;">'+money+'</h2>'
										    +'</a>'
			        					}
			        		         $("#monthDiv").find("div[class=packageList]").append(dataDiv);
			        		         $("#monthDiv").show();
		        	        	 }
		        			 }
		        	      });
                		  // 记载年度充值数据
		        	  	   $.ajax({            
		        	         type:"POST",   //post提交方式默认是get
		        	         url:'/XuYuRepos/xuyupackages/views',
		        	         type:"POST",   //post提交方式默认是get
		        	         data : {
		        	        	 id : id,
		        	        	 type: data.provider+";12",
		        	        	 comeon:'n'
		        	         },
		        	         success:function(data){
		        	        	 if(data.total>0){
		        	        		 $("#yearDiv").find("div[class=packageList]").html("");
			        		        	var dataDiv="";
			        		        	for (var int = 0; int < data.total; int++) {
			        		        		var taocan=data.rows[int].desc;
			        		        		var money=data.rows[int].selfPrice.toFixed(2)+'元';
			        		        		dataDiv=dataDiv+'<a class="packageItem" style="margin-left: 5px;"><input type="hidden" value="'+data.rows[int].id+'"/>'
											+'<h2 style="font-size:18px;margin-top: 10px;margin-bottom: 0px;">'+taocan+'</h2>'
											+'<h2 style="font-size:0.8rem;margin-top: 0px;margin-bottom: 10px;">'+money+'</h2>'
										    +'</a>'
			        					}
			        		         $("#yearDiv").find("div[class=packageList]").append(dataDiv);
			        		         $("#yearDiv").show();
		        	        	 }
		        	        	
		        			 }
		        	      });
                		  // 记载加油包的数据
		        	  	 $.ajax({            
		        	         type:"POST",   //post提交方式默认是get
		        	         url:'/XuYuRepos/xuyupackages/views',
		        	         type:"POST",   //post提交方式默认是get
		        	         data : {
		        	        	 id : id,
		        	        	 type: data.provider+";1",
		        	        	 comeon:'y'
		        	         },
		        	         success:function(data){
		        	        	     if(data.total>0){
			        	        		 $("#jyDiv").find("div[class=packageList]").html("");
				        		        	var dataDiv="";
				        		        	for (var int = 0; int < data.total; int++) {
				        		        		var taocan=data.rows[int].desc;
				        		        		var money=data.rows[int].selfPrice.toFixed(2)+'元';
				        		        		dataDiv=dataDiv+'<a class="packageItem" style="margin-left: 5px;"><input type="hidden" value="'+data.rows[int].id+'"/>'
												+'<h2 style="font-size:18px;margin-top: 10px;margin-bottom: 0px;">'+taocan+'</h2>'
												+'<h2 style="font-size:0.8rem;margin-top: 0px;margin-bottom: 10px;">'+money+'</h2>'
											    +'</a>'
				        					}
				        		         $("#jyDiv").find("div[class=packageList]").append(dataDiv);
				        		         $("#jyDiv").show();
		        	        	    }
		        	        	   
		        			 }
		        	      });
                	 }else{
                		 layer.msg('账号错误请检查');
                	 }
		         }
			 });
		}
	});
	
	$("#accessNums").on("keydown",function(){
		if (event.keyCode == "13") {
			var accessNums=$("#accessNums").val();
			if(accessNums==''){
				 layer.msg('请输入充值账号');
			}else{
				 $.ajax({            
			         type:"POST",   //post提交方式默认是get
			         data : {
			        	 accessNums : accessNums
			         },
			         url:'/XuYuRepos/alipay/checkNums',
			         success:function(data){
			        	 // 获取当前运营商的类别
			        	 if(data.result==true){
			        		 var id=$.getUrlParam("id");
			        		 
			        		 $("#ycdiv").show();
			        		 
	                		 // 加载月份充值数据
			        	  	 $.ajax({            
			        	         type:"POST",   //post提交方式默认是get
			        	         url:'/XuYuRepos/xuyupackages/views',
			        	         type:"POST",   //post提交方式默认是get
			        	         data : {
			        	        	 id : id,
			        	        	 type: data.provider+";1",
			        	        	 comeon:'n'
			        	         },
			        	         success:function(data){
			        	        	 if(data.total>0){
			        	        		 $("#monthDiv").find("div[class=packageList]").html("");
				        		        	var dataDiv="";
				        		        	for (var int = 0; int < data.total; int++) {
				        		        		var taocan=data.rows[int].desc;
				        		        		var money=data.rows[int].selfPrice.toFixed(2)+'元';
				        		        		dataDiv=dataDiv+'<a class="packageItem" style="margin-left: 5px;"><input type="hidden" value="'+data.rows[int].id+'"/>'
												+'<h2 style="font-size:18px;margin-top: 10px;margin-bottom: 0px;">'+taocan+'</h2>'
												+'<h2 style="font-size:0.8rem;margin-top: 0px;margin-bottom: 10px;">'+money+'</h2>'
											    +'</a>'
				        					}
				        		         $("#monthDiv").find("div[class=packageList]").append(dataDiv);
				        		         $("#monthDiv").show();
			        	        	 }
			        			 }
			        	      });
	                		  // 记载年度充值数据
			        	  	   $.ajax({            
			        	         type:"POST",   //post提交方式默认是get
			        	         url:'/XuYuRepos/xuyupackages/views',
			        	         type:"POST",   //post提交方式默认是get
			        	         data : {
			        	        	 id : id,
			        	        	 type: data.provider+";12",
			        	        	 comeon:'n'
			        	         },
			        	         success:function(data){
			        	        	 if(data.total>0){
			        	        		 $("#yearDiv").find("div[class=packageList]").html("");
				        		        	var dataDiv="";
				        		        	for (var int = 0; int < data.total; int++) {
				        		        		var taocan=data.rows[int].desc;
				        		        		var money=data.rows[int].selfPrice.toFixed(2)+'元';
				        		        		dataDiv=dataDiv+'<a class="packageItem" style="margin-left: 5px;"><input type="hidden" value="'+data.rows[int].id+'"/>'
												+'<h2 style="font-size:18px;margin-top: 10px;margin-bottom: 0px;">'+taocan+'</h2>'
												+'<h2 style="font-size:0.8rem;margin-top: 0px;margin-bottom: 10px;">'+money+'</h2>'
											    +'</a>'
				        					}
				        		         $("#yearDiv").find("div[class=packageList]").append(dataDiv);
				        		         $("#yearDiv").show();
			        	        	 }
			        	        	
			        			 }
			        	      });
	                		  // 记载加油包的数据
			        	  	 $.ajax({            
			        	         type:"POST",   //post提交方式默认是get
			        	         url:'/XuYuRepos/xuyupackages/views',
			        	         type:"POST",   //post提交方式默认是get
			        	         data : {
			        	        	 id : id,
			        	        	 type: data.provider+";1",
			        	        	 comeon:'y'
			        	         },
			        	         success:function(data){
			        	        	     if(data.total>0){
				        	        		 $("#jyDiv").find("div[class=packageList]").html("");
					        		        	var dataDiv="";
					        		        	for (var int = 0; int < data.total; int++) {
					        		        		var taocan=data.rows[int].desc;
					        		        		var money=data.rows[int].selfPrice.toFixed(2)+'元';
					        		        		dataDiv=dataDiv+'<a class="packageItem" style="margin-left: 5px;"><input type="hidden" value="'+data.rows[int].id+'"/>'
													+'<h2 style="font-size:18px;margin-top: 10px;margin-bottom: 0px;">'+taocan+'</h2>'
													+'<h2 style="font-size:0.8rem;margin-top: 0px;margin-bottom: 10px;">'+money+'</h2>'
												    +'</a>'
					        					}
					        		         $("#jyDiv").find("div[class=packageList]").append(dataDiv);
					        		         $("#jyDiv").show();
			        	        	    }
			        	        	   
			        			 }
			        	      });
	                	 }else{
	                		 layer.msg('账号错误请检查');
	                	 }
			         }
				 });
			}
		}
	});
	
    
	
    var id=$.getUrlParam("id");
    if(id==null){
    	layer.msg('非法参数');
    	custom_close();
    }else{
	   	// 套餐默认不加载
	   	$("#ycdiv").hide();
	   	$("#monthDiv").hide();
	   	$("#yearDiv").hide();
	   	$("#jyDiv").hide();
    }
})(jQuery);

</script>
</html>