<?xml version="1.0" encoding="UTF-8"?>  
<!DOCTYPE mapper    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xuyurepos.dao.payment.XuyuRechargeDao">
	<resultMap type="com.xuyurepos.entity.payment.XuyuRecharge" id="paymentOrder">
		<!-- column存数据库中的属性   property存javabean中数据-->
		<id column="ID" jdbcType="BIGINT" property="id" />
	    <result column="ACCESS_NUM" jdbcType="VARCHAR" property="accessNum" />
	    <result column="COMBO_TYPE" jdbcType="VARCHAR" property="comboType" />
	    <result column="COMNO_NAME" jdbcType="VARCHAR" property="comnoName" />
	    <result column="TOTAL_GPRS" jdbcType="DECIMAL" property="totalGprs" />
	    <result column="PRICE" jdbcType="DECIMAL" property="price" />
	    <result column="MONEY" jdbcType="DECIMAL" property="money" />
	    <result column="IS_PAY" jdbcType="VARCHAR" property="isPay" />
	    <result column="CREATE_DATE" jdbcType="TIMESTAMP" property="createDate" />
	    <result column="CREATE_USER" jdbcType="VARCHAR" property="createUser" />
	    <result column="CREATE_ORG" jdbcType="VARCHAR" property="createOrg" />
	    <result column="CUSTOMER" jdbcType="VARCHAR" property="customer" />
	    <result column="PACKAGES_ID" jdbcType="VARCHAR" property="packagesId" />
	    <result column="COMMISSION" jdbcType="DECIMAL" property="commission" />
	    <result column="COMMISSION_MONEY" jdbcType="DECIMAL" property="commissionMoney" />
	    <result column="PAY_COMMISSION" jdbcType="VARCHAR" property="payCommission" />
	    <result column="YC" jdbcType="VARCHAR" property="yc" />
	    <result column="IS_DEAL" jdbcType="VARCHAR" property="isDeal" />
	    <result column="COME_ON" jdbcType="VARCHAR" property="comeon" />
	    <result column="ICCID" jdbcType="VARCHAR" property="iccid" />
	    
	    <result column="TRADE_TYPE" jdbcType="VARCHAR" property="tradeType" />
	    <result column="ORDER_STATUS" jdbcType="VARCHAR" property="orderStatus" />
	    <result column="UPDATETIME" jdbcType="VARCHAR" property="updateTime" />
	    
	    <result column="ORG_NAME" jdbcType="VARCHAR" property="orgName" />
	    <result column="TRADE_NO" jdbcType="VARCHAR" property="tradeNo" />
	</resultMap>
	
	<select id="find" parameterType="String" resultType="com.xuyurepos.entity.payment.XuyuRecharge">
          select * from XUYU_RECHARGE t1 where t1.ID=#{id}
    </select>
    
    <delete id="del" parameterType="String">
          delete from XUYU_RECHARGE 
          where ID=#{id}
    </delete>
	
    <insert id="insert" parameterType="com.xuyurepos.entity.payment.XuyuRecharge">
	    <!--
	      WARNING - @mbggenerated
	      This element is automatically generated by MyBatis Generator, do not modify.
	      This element was generated on Tue Apr 30 15:42:34 CST 2019.
	    -->
	    insert into XUYU_RECHARGE (ID,ACCESS_NUM, COMBO_TYPE, 
	      COMNO_NAME, TOTAL_GPRS, PRICE,MONEY, 
	      IS_PAY, CREATE_DATE, CREATE_USER, 
	      CREATE_ORG, CUSTOMER, PACKAGES_ID, 
	      COMMISSION, COMMISSION_MONEY, PAY_COMMISSION,
	      YC,IS_DEAL,COME_ON,ICCID,PROVIDER
	      )
	    values (#{id,jdbcType=VARCHAR},#{accessNum,jdbcType=VARCHAR}, #{comboType,jdbcType=VARCHAR}, 
	      #{comnoName,jdbcType=VARCHAR}, #{totalGprs,jdbcType=DECIMAL}, #{price,jdbcType=DECIMAL},  #{money,jdbcType=DECIMAL}, 
	      #{isPay,jdbcType=VARCHAR}, #{createDate,jdbcType=TIMESTAMP}, #{createUser,jdbcType=VARCHAR}, 
	      #{createOrg,jdbcType=VARCHAR}, #{customer,jdbcType=VARCHAR}, #{packagesId,jdbcType=VARCHAR}, 
	      #{commission,jdbcType=DECIMAL}, #{commissionMoney,jdbcType=DECIMAL}, #{payCommission,jdbcType=VARCHAR},
	      #{yc,jdbcType=VARCHAR},#{isDeal,jdbcType=VARCHAR},#{comeon,jdbcType=VARCHAR},#{iccid,jdbcType=VARCHAR},
	      #{provider,jdbcType=VARCHAR}
	      )
    </insert>
    
    	
    <insert id="createOrder" parameterType="com.xuyurepos.entity.payment.XuyuRecharge">
	    <!--
	      WARNING - @mbggenerated
	      This element is automatically generated by MyBatis Generator, do not modify.
	      This element was generated on Tue Apr 30 15:42:34 CST 2019.
	    -->
	    insert into XUYU_RECHARGE (ID,ACCESS_NUM, COMBO_TYPE, 
	      COMNO_NAME, TOTAL_GPRS, PRICE,MONEY, 
	      IS_PAY, CREATE_DATE, CREATE_USER, 
	      CREATE_ORG, CUSTOMER, PACKAGES_ID, 
	      COMMISSION, COMMISSION_MONEY, PAY_COMMISSION,
	      YC,IS_DEAL,COME_ON,ICCID,PROVIDER
	      )
	    values (#{id,jdbcType=VARCHAR},#{accessNum,jdbcType=VARCHAR}, #{comboType,jdbcType=VARCHAR}, 
	      #{comnoName,jdbcType=VARCHAR}, #{totalGprs,jdbcType=DECIMAL}, #{price,jdbcType=DECIMAL},  #{money,jdbcType=DECIMAL}, 
	      #{isPay,jdbcType=VARCHAR}, #{createDate,jdbcType=TIMESTAMP}, #{createUser,jdbcType=VARCHAR}, 
	      #{createOrg,jdbcType=VARCHAR}, #{customer,jdbcType=VARCHAR}, #{packagesId,jdbcType=VARCHAR}, 
	      #{commission,jdbcType=DECIMAL}, #{commissionMoney,jdbcType=DECIMAL}, #{payCommission,jdbcType=VARCHAR},
	      #{yc,jdbcType=VARCHAR},#{isDeal,jdbcType=VARCHAR},#{comeon,jdbcType=VARCHAR},#{iccid,jdbcType=VARCHAR},
	      #{provider,jdbcType=VARCHAR}
	      )
    </insert>
    
    <insert id="insertAccs" parameterType="hashmap">
	    insert into XUYU_RECHARGE(ID,
		          ACCESS_NUM,ICCID, COMBO_TYPE, 
			      COMNO_NAME, TOTAL_GPRS, PRICE,MONEY, 
			      IS_PAY,CREATE_USER, 
			      CREATE_ORG,CREATE_DATE,
			      CUSTOMER ,COME_ON,YC,PROVIDER
		)
		select 
		_nextval('recharge'),
		t1.ACCESS_NUM,
		t1.ICCID,
		t1.COMBO_TYPE,
		t1.COMNO_NAME,
		t1.COMBO_TYPE*t1.COMNO_NAME*#{record.chargeCost,jdbcType=VARCHAR} as totalGprs,
		t1.UNIT_COST,
		t1.UNIT_COST*#{record.chargeCost,jdbcType=VARCHAR},
		#{record.isPay,jdbcType=VARCHAR} as IS_PAY,
		#{record.createUser,jdbcType=VARCHAR} as CREATE_USER,
		#{record.createOrg,jdbcType=VARCHAR} as CREATE_ORG,
		DATE_FORMAT(now(),'%Y-%m-%d %H:%i:%S') as CREATE_DATE, 
		t1.AGENCY,
		'n' as COME_ON,
		'n' as YC,
		t1.PROVIDER
		
		from
		XUYU_CONTENT_CARD_INFO t1 WHERE  1=1
		
		<if test="record.numType==01">
			  AND ACCESS_NUM &gt;='${record.accessNumStart}'
			  AND ACCESS_NUM &lt;='${record.accessNumEnd}'
		 </if>
		 <if test="record.numType==02">
	         AND ICCID &gt;= '${record.accessNumStart}'
		     AND ICCID &lt;= '${record.accessNumEnd}' 
	     </if>
    </insert>
    
    <insert id="insertAccsNew" parameterType="hashmap">
	    insert into XUYU_RECHARGE(ID,
		          ACCESS_NUM,ICCID, COMBO_TYPE, 
			      COMNO_NAME, TOTAL_GPRS, PRICE,MONEY, 
			      IS_PAY,CREATE_USER, 
			      CREATE_ORG,CREATE_DATE,
			      CUSTOMER ,COME_ON,YC,PROVIDER
		)
		select 
		_nextval('recharge'),
		t1.ACCESS_NUM,
		t1.ICCID,
		t1.COMBO_TYPE,
		t1.COMNO_NAME,
		t1.COMBO_TYPE*t1.COMNO_NAME*#{record.chargeCost,jdbcType=VARCHAR} as totalGprs,
		t1.UNIT_COST,
		t1.UNIT_COST*#{record.chargeCost,jdbcType=VARCHAR},
		#{record.isPay,jdbcType=VARCHAR} as IS_PAY,
		#{record.createUser,jdbcType=VARCHAR} as CREATE_USER,
		#{record.createOrg,jdbcType=VARCHAR} as CREATE_ORG,
		DATE_FORMAT(now(),'%Y-%m-%d %H:%i:%S') as CREATE_DATE, 
		t1.AGENCY,
		'n' as COME_ON,
		'n' as YC,
		t1.PROVIDER
		
		from
		XUYU_CONTENT_CARD_INFO t1 WHERE  1=1
		
		<if test="record.numType==01">
			  AND EXISTS (
			  select 1 from MSG_TEMP a1 where a1.ACCESS_NUM=t1.ACCESS_NUM
		      )
		 </if>
		 <if test="record.numType==02">
		      AND EXISTS (
			  select 1 from MSG_TEMP a1 where a1.ACCESS_NUM=t1.ICCID
		      )
	     </if>
    </insert>
    
    
 
	<update id="update" parameterType="com.xuyurepos.entity.payment.XuyuRecharge">
	    <!--
	      WARNING - @mbggenerated
	      This element is automatically generated by MyBatis Generator, do not modify.
	      This element was generated on Tue Apr 30 15:42:34 CST 2019.
	    -->
		    update XUYU_RECHARGE
		    set ACCESS_NUM = #{accessNum,jdbcType=VARCHAR},
		      COMBO_TYPE = #{comboType,jdbcType=VARCHAR},
		      COMNO_NAME = #{comnoName,jdbcType=VARCHAR},
		      TOTAL_GPRS = #{totalGprs,jdbcType=DECIMAL},
		      PRICE = #{price,jdbcType=DECIMAL},
		      MONEY = #{money,jdbcType=DECIMAL},
		      IS_PAY = #{isPay,jdbcType=VARCHAR},
		      CREATE_DATE = #{createDate,jdbcType=TIMESTAMP},
		      CREATE_USER = #{createUser,jdbcType=VARCHAR},
		      CREATE_ORG = #{createOrg,jdbcType=VARCHAR},
		      CUSTOMER = #{customer,jdbcType=VARCHAR},
		      PACKAGES_ID = #{packagesId,jdbcType=VARCHAR},
		      COMMISSION = #{commission,jdbcType=DECIMAL},
		      COMMISSION_MONEY = #{commissionMoney,jdbcType=DECIMAL},
		      PAY_COMMISSION = #{payCommission,jdbcType=VARCHAR},
		      YC = #{yc,jdbcType=VARCHAR},
		      IS_DEAL = #{isDeal,jdbcType=VARCHAR}
		    where ID = #{id,jdbcType=BIGINT}
   </update>
   
    <sql id="sql_count">
        SELECT COUNT(*)
    </sql>
    
    <sql id="sql_select">
        SELECT 	a.*,
	    b.ORG_NAME
    </sql>
    
    <sql id="sql_countCus">
        SELECT COUNT(*)
    </sql>
    
    <sql id="sql_selectCus">
         SELECT t1.*,t2.TRADE_TYPE,t2.ORDER_STATUS,t2.updatetime, t3.ORG_NAME,t2.TRADE_NO
    </sql>
    
    <sql id="sql_where">
        FROM XUYU_RECHARGE a  
        left join SYSTEM_AUTH_ORG b on a.CUSTOMER=b.id
        where IS_PAY='y'
             <if test="queryObj != null">
                <if test="queryObj.accessNum != null and queryObj.accessNum != ''">
                    AND ACCESS_NUM=#{queryObj.accessNum}
                </if>
                <if test="queryObj.customer != null and queryObj.customer != ''">
                    and EXISTS (
					SELECT 1 FROM SYSTEM_AUTH_ORG b where b.ORG_ID like '${queryObj.customer}%' and b.ID=a.CUSTOMER
				    )
		        </if>
                <if test="queryObj.createUser != null and queryObj.createUser != ''">
                    AND CREATE_USER like 
                    '%${queryObj.createUser}%'
                </if>
                <if test="queryObj.createDateStart != null and queryObj.createDateStart != ''">
                    AND CREATE_DATE &gt;= str_to_date('${queryObj.createDateStart}','%Y-%m-%d')
                </if>
                <if test="queryObj.createDateEnd != null and queryObj.createDateEnd != ''">
                    AND CREATE_DATE &lt;= str_to_date('${queryObj.createDateEnd}','%Y-%m-%d')
                </if>
                <if test="queryObj.accessNumStart != null and queryObj.accessNumStart != ''">
                    AND ACCESS_NUM &gt;= '${queryObj.accessNumStart}'
                </if>
                <if test="queryObj.accessNumEnd != null and queryObj.accessNumEnd != ''">
                    AND ACCESS_NUM &lt;= '${queryObj.accessNumEnd}'
                </if>
                <if test="queryObj.availableType != null and queryObj.availableType != ''">
                    AND COMBO_TYPE= '${queryObj.availableType}'
                </if>
                <if test="queryObj.comeon != null and queryObj.comeon != ''">
                    AND COME_ON= '${queryObj.comeon}'
                </if>
                <if test="queryObj.yc != null and queryObj.yc != ''">
                    AND YC='${queryObj.yc}'
                </if>
            </if>
            order by CREATE_DATE desc
    </sql>
    
    <sql id="sql_whereCus">
         FROM 
			(select * from XUYU_RECHARGE a where IS_PAY='n'
				 <if test="queryObj != null">
		                <if test="queryObj.accessNum != null and queryObj.accessNum != ''">
		                    AND ACCESS_NUM=#{queryObj.accessNum}
		                </if>
		                <if test="queryObj.customer != null and queryObj.customer != ''">
		                    and EXISTS (
							SELECT 1 FROM SYSTEM_AUTH_ORG b where b.ORG_ID like '${queryObj.customer}%' and b.ID=a.CUSTOMER
						    )
		                </if>
		                <if test="queryObj.availableType != null and queryObj.availableType != ''">
		                    AND COMBO_TYPE=#{queryObj.availableType}
		                </if>
		                <if test="queryObj.createDateStart != null and queryObj.createDateStart != ''">
		                    AND CREATE_DATE &gt;= str_to_date('${queryObj.createDateStart}','%Y-%m-%d')
		                </if>
		                <if test="queryObj.createDateEnd != null and queryObj.createDateEnd != ''">
		                    AND CREATE_DATE &lt;= str_to_date('${queryObj.createDateEnd}','%Y-%m-%d')
		                </if>
		                <if test="queryObj.accessNumStart != null and queryObj.accessNumStart != ''">
		                    AND ACCESS_NUM &gt;= '${queryObj.accessNumStart}'
		                </if>
		                <if test="queryObj.accessNumEnd != null and queryObj.accessNumEnd != ''">
		                    AND ACCESS_NUM &lt;= '${queryObj.accessNumEnd}'
		                </if>
		                <if test="queryObj.comeon != null and queryObj.comeon != ''">
		                    AND COME_ON= '${queryObj.comeon}'
		                </if>
		                <if test="queryObj.yc != null and queryObj.yc != ''">
		                    AND YC= '${queryObj.yc}'
		                </if>
		            </if>
			 ) t1
			 <if test="queryObj != null">
			     <choose>
			        <when test="queryObj.orderStatus!=null and queryObj.orderStatus!= ''">
			            INNER join XUYU_PAYMENT t2 on t1.id=t2.TRADE_NO
			            AND t2.ORDER_STATUS='${queryObj.orderStatus}'
			        </when>
			         <when test="queryObj.tradeType!=null and queryObj.tradeType!= ''">
			            <if test="queryObj.orderStatus== null or queryObj.orderStatus == ''">
			                  INNER join XUYU_PAYMENT t2 on t1.id=t2.TRADE_NO
			            </if>
			            AND t2.TRADE_TYPE='${queryObj.tradeType}'
			        </when>
			        <otherwise>
			            LEFT join XUYU_PAYMENT t2 on t1.id=t2.TRADE_NO
			        </otherwise>
			    </choose>
			 </if>
			 LEFT JOIN SYSTEM_AUTH_ORG t3 on t1.CUSTOMER=t3.id
            order by t1.CREATE_DATE desc    
    </sql>
    
   <select id="selectUserListWithPage" parameterType="com.xuyurepos.common.page.PageModel" resultType="com.xuyurepos.entity.payment.XuyuRecharge">
        <include refid="sql_select"></include>
        <include refid="sql_where"></include>
        <if test="pageNumber != null and  pageSize!= null">
            limit #{startRow},#{pageSize}
        </if>
    </select>
    
    <select id="selectCustomerListWithPage" parameterType="com.xuyurepos.common.page.PageModel" resultType="com.xuyurepos.entity.payment.XuyuRecharge">
        <include refid="sql_selectCus"></include>
        <include refid="sql_whereCus"></include>
        <if test="pageNumber != null and  pageSize!= null">
            limit #{startRow},#{pageSize}
        </if>
    </select>

    <select id="selectUserCountWithPage" parameterType="com.xuyurepos.common.page.PageModel" resultType="Integer">
        <include refid="sql_count"></include>
        <include refid="sql_where"></include>
    </select>
    
    <select id="selectCustomerCountWithPage" parameterType="com.xuyurepos.common.page.PageModel" resultType="Integer">
        <include refid="sql_countCus"></include>
        <include refid="sql_whereCus"></include>
    </select>
    
</mapper>