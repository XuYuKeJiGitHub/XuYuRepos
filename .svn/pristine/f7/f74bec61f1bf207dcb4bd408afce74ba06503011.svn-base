package com.xuyurepos.service.intergration.xuyu.facade;

import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.Random;
import java.util.TreeMap;

import com.alibaba.fastjson.JSON;
import com.xuyurepos.common.util.JsonUtil;
import com.xuyurepos.common.util.SecretUtils;
import com.xuyurepos.common.util.httpclient.HttpTookit;
import com.xuyurepos.service.intergration.xuyu.mobile.sign.CMPSign;

public class MobileCMPRequest {

	private static final String request_uri="http://localhost:8001/api/V1/";
	
	public static  Map  init() {
		Map map=new HashMap();
//		map.put("transationid", "201610311205321235962014101615303080000001");
		map.put("appid", "2017053015123929905")	;
//		map.put("ability", "onlineGPRSRealQuery");
		map.put("timestamp",timestamp(new Date(),"yyyyMMddHHmmss"));
		map.put("randomstr",getStringRandom(32));
        return map;
		
	}
	
	
	
	public static String timestamp(Date date,String format) {
		SimpleDateFormat sdf=new SimpleDateFormat(format);
	 return 	sdf.format(date);
	}
	
	 //生成随机数字和字母,  
    public static String getStringRandom(int length) {  
          
        String val = "";  
        Random random = new Random();  
          
        //参数length，表示生成几位随机数  
        for(int i = 0; i < length; i++) {  
              
            String charOrNum = random.nextInt(2) % 2 == 0 ? "char" : "num";  
            //输出字母还是数字  
            if( "char".equalsIgnoreCase(charOrNum) ) {  
                //输出是大写字母还是小写字母  
//                int temp = random.nextInt(2) % 2 == 0 ? 65 : 97;  
                val += (char)(random.nextInt(26) + 97);  
            } else if( "num".equalsIgnoreCase(charOrNum) ) {  
                val += String.valueOf(random.nextInt(10));  
            }  
        }  
        return val;  
    }  
	
    /**
     *  移动本地上海
     * @param msisdn 所查询的专网号码
     * @param ability 能力编码，在api应用管理中开通，ability范例：onlineGPRSRealQuery
     * @return
     */
    public static String nativeMobileCMPRequest(String msisdn,String ability) {

		Map<String,String> initMap=init();
		
	   String 	transationid=initMap.get("appid")+timestamp(new Date(),"yyyyMMddHHmmssSSSSSSSS");
	 
	   initMap.put("ability", ability);
	   initMap.put("transationid", transationid);
	   
	Map body=new HashMap();
	body.put("msisdn", msisdn);
	initMap.put("body",JSON.toJSONString(body));
	String sign=	CMPSign.sign(initMap);
	initMap.put("sign",sign);


	String result=	HttpTookit.doPost(request_uri+ability, JsonUtil.parseMap2Json(initMap),"UTF-8");
	System.out.println(result);
//	String result=CMPSubmit.buildRequestPost("","",map, "http://183.230.96.66:8087/v2/gprsrealsingle");
//	System.out.println(result);
   return result;
	
    }
    /**
     *  移动全国
     * @param ebid
     * @param msisdn
     * @param requestUrl
     * @return
     */
   public static String wholeMobileCMPRequest(String requestUrl,String ebid,String msisdn) {
    Map<String,String> map=new TreeMap();
	String transid=   timestamp(new Date(),"yyyyMMddHHmmssSSSSSSSS");
		map.put("ebid", ebid);
		map.put("appid", "DU2U478")	;
       map.put("transid","1000012014101615303080000001");
      map.put("msisdn", msisdn);	 
     String password="XYXX543sh";
     String token= SecretUtils.getSHA256StrJava(  map.get("appid")+password+map.get("transid"));
     map.put("token",token);



	String result=	HttpTookit.doGet(requestUrl,map,"UTF-8");
	System.out.println(result);
   return result;
   }
    
	
	public static void main(String[] args) {
		nativeMobileCMPRequest("1440082636750", "onlineGPRSRealQuery");
        wholeMobileCMPRequest("http://localhost:8002/v2/gprsrealsingle","0001000000008", "1440082636750");
	}
}
