package com.xuyurepos.service.impl.manager;

import java.math.BigDecimal;
import java.util.Calendar;
import java.util.Date;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;

import org.apache.log4j.Logger;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.xuyurepos.common.constants.SystemConstants;
import com.xuyurepos.common.log.LoggerFactory;
import com.xuyurepos.common.util.DateUtil;
import com.xuyurepos.dao.comm.CommonMapper;
import com.xuyurepos.dao.manager.XuyuContentCardInfoDao;
import com.xuyurepos.entity.manager.XuyuContentCardInfo;
import com.xuyurepos.service.manager.XuyuContentCardInfoClearService;
/**
 * 批量到期清空当前数据以及处理预充值
 * @author yangfei
 */
@Service
@Transactional
public class XuyuContentCardInfoClearServiceImpl implements XuyuContentCardInfoClearService{
	
	Logger logger=LoggerFactory.getInstance().getLogger(XuyuContentCardInfoClearServiceImpl.class);
	
	@Resource
	private CommonMapper commonMapper;
	
	@Resource
	private XuyuContentCardInfoDao xuyuContentCardInfoDao;
	
	@SuppressWarnings("rawtypes")
	@Override
	public void clear() {
		try {
			// 第一步处理到期的数据
			// 直接将数据清空
			StringBuilder sb=new StringBuilder();
			sb.append(" update XUYU_CONTENT_CARD_INFO t1 set t1.TOTAL_GPRS=0.00 where 1=1");
			sb.append(" and  t1.DEADLINE_DATE=DATE_SUB(curdate(),INTERVAL 1 DAY) ");
			sb.append(" and (t1.`OWNER` is  null or LENGTH(trim(t1.`OWNER`))<1) ");
			commonMapper.executeAction(sb.toString());
			
			// 预充值的数据开始处理
			sb=new StringBuilder();
			sb.append(" select * from XUYU_RECHARGE t1 where t1.YC='y' and t1.IS_DEAL='n' ");
			List<Map<String, Object>> list=commonMapper.findManyData(sb.toString());
			if(list.size()>0){
				Map map=null;
				for (int i = 0; i < list.size(); i++) {
					map=list.get(i);
					XuyuContentCardInfo xuyuContentCardInfo=xuyuContentCardInfoDao.find(SystemConstants.STRINGEMPTY+map.get("ACCESS_NUM"));
					// 直接设置套餐的总量
					Calendar calendar = Calendar.getInstance();
					calendar.setTime(new Date());
					BigDecimal totalGprs=BigDecimal.valueOf(Double.valueOf(SystemConstants.STRINGEMPTY+map.get("TOTAL_GPRS")));
					xuyuContentCardInfo.setComboType(SystemConstants.STRINGEMPTY+map.get("AVAILABLE_TYPE"));
					xuyuContentCardInfo.setComnoName(SystemConstants.STRINGEMPTY+map.get("COMNO_NAME"));
					xuyuContentCardInfo.setTotalGprs(totalGprs);
					xuyuContentCardInfo.setUseGprs(BigDecimal.valueOf(0.00));
					xuyuContentCardInfo.setRemainGps(BigDecimal.valueOf(0.00));
					xuyuContentCardInfo.setActivateDateRestart(calendar.getTime());
					
					String testType=xuyuContentCardInfo.getTestType();
					String waitType=xuyuContentCardInfo.getWaitType();
					// 没有测试期和成默契直接计算
					if(SystemConstants.STRINGEMPTY.equals(testType)
							   &&SystemConstants.STRINGEMPTY.equals(waitType)){
						Date deadlineDate=DateUtil.getLastMonthdate(xuyuContentCardInfo.getActivateDate(), Integer.valueOf(xuyuContentCardInfo.getComboType()));
						xuyuContentCardInfo.setDeadlineDate(deadlineDate);
					}else{
						// 如果沉默期和测试期存在的情况
						// 得需要更新的时候计算
					}
					// 更新时间和是否处理
					sb=new StringBuilder();
					sb.append(" update xuyu_recharge set IS_DEAL='y',UPDATE_DATE=SYSDATE() where");
					sb.append("  ID="+map.get("ID"));
					commonMapper.executeAction(sb.toString());
					xuyuContentCardInfoDao.update(xuyuContentCardInfo);
				}
			}
		} catch (Exception e) {
			logger.info("月末跑批失败:"+e.getMessage());
			e.printStackTrace();
		}
		
		
	}

}
