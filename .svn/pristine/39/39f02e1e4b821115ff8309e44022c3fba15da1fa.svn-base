<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <title>获取授权页面</title>
</head>
<body>
<script src="../js/jquery.min-1.12.4.js"></script>
		<script type="text/javascript">
			function onBridgeReady(){
				 WeixinJSBridge.invoke(
				            'getBrandWCPayRequest', {
				                "appId": appId,     //公众号名称，由商户传入
				                "timeStamp": timeStamp,         //时间戳，自1970年以来的秒数
				                "nonceStr": nonceStr, //随机串
				                "package": vpackage,
				                "signType": signType,//"MD5",         //微信签名方式：
				                "paySign": paySign //微信签名
				            },
				            function (res) {
				            	// 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠
				                if (res.err_msg == "get_brand_wcpay_request：ok") {
				                		window.location.href="https://iots.shingsou.com/wxpay/notify";
				                	}else if(res.err_msg == "get_brand_wcpay_request：cancel"){//取消支付
				                		$('#refreshPayid').val('N');
				                		cancel();
					                	if($('#isDirect').val()=='Y'&&!isEmpty(showCancelUrl)){
					                		window.location.href=showCancelUrl;
					                	}
				                	}else{
				                		//唤起失败
				                		cancel();
				                		$('#isDirect').val('Y');
				                		toErrorPage("微信唤起失败，请稍后重试"+res.err_msg,showFailUrl);
				                	}
				                	recoverBtn();
				                	sessionStorage.getItem('loadPay',false);
				                }
				            
				 );
			}
		
			(function ($) {
			    $.getUrlParam = function (name) {
			        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
			        var r = window.location.search.substr(1).match(reg);
			        if (r != null) return unescape(r[2]); return null;
			    }
			    var code=$.getUrlParam("code");
			    $.ajax({            
	   		         type:"POST",   //post提交方式默认是get
	   		         data : {
	   		        	 code : code
	   		         },
	   		         url:'/XuYuRepos/wxpay/wxOpenId',
	   		         success:function(data){
	   		        	 var out_trade_no='2016090910595900000014';
		   		         if(out_trade_no!=null&&out_trade_no!=""){
		   		        	 alert(JSON.parse(data).openId);
		   		             // 直接获取支付参数
			        		 $.ajax({            
	            		         type:"POST",   //post提交方式默认是get
	            		         data : {
	            		        	 totalFee : 0.01,
	            		        	 tradeType:'JSAPI',
	            		        	 out_trade_no:out_trade_no,
	            		        	 openid:JSON.parse(data).openId
	            		         },
	            		         url:'/XuYuRepos/wxpay/pay',
	            		         success:function(data){
	            		        	 appid=data.appid;//公众号名称,商户传入
	         						 timeStamp=data.timeStamp;//时间戳,自1970年以来的秒
	         						 nonceStr=data.nonceStr;//随机窜
	         						 vpackage=data.vpackage;
	         						 signType=data.signType;//微信签名方式
	         						 paySign=data.paySign;
	         						 if(vpackage!=null&&vpackage!=""){
	        							if(typeof WeixinJSBrige=="undefined"){
	        								//异常情况处理 再补充
	        							}else{
	        								onBridgeReady();
	        							}
	        						 }
	            		         }
			        	    });
		   		         }else{
		   		        	 alert("没有订单号");
		   		         }
	   		         }
       	        });
			    
			    
			})(jQuery);
</script>
</body>
</html>