<?xml version="1.0" encoding="UTF-8"?>  
<!DOCTYPE mapper  
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xuyurepos.dao.autorule.AotoRuleManagerDao">
	 <insert id="saveRule" parameterType="com.xuyurepos.vo.autorule.AutoRuleManagerDTO">
         INSERT INTO XUYU_RULE_INFO (
				RULE_ID,
				RULE_TYPE,
				RULE_VALUE,
				GPRS,
				RULE_DESC,
				RULE_NAME,
				INVALID,
				OWNER,
				OWNER_NAME,
				ACCESS_NUM,
				ACCESS_NUM_START,
				ACCESS_NUM_END,
				DAYS,
				MESSAGE_PHONE,
				MESSAGE_MAIL,
				AFFECT_RANGE,
				START_DATE,
				CREATE_DATE,
				CREATE_USER,
				UPDATE_DATE,
				UPDATE_USER,
				OPRATE_TYPE 
			)
			VALUES(
	          #{ruleId,javaType=String}
	          ,#{ruleType,javaType=String}
	          ,#{rate,javaType=DECIMAL}
	          ,#{gprs,javaType=DECIMAL}
	          ,#{ruleDesc,javaType=String}
	          ,#{ruleName,javaType=String}
	          ,'Y'
	          ,#{ownerId,javaType=String}
	          ,#{ownerName,javaType=String}
	          ,#{accessNums,javaType=String}
	          ,#{accessNumStart,javaType=String}
	          ,#{accessNumEnd,javaType=String}
	          ,#{days,javaType=DECIMAL}
	          ,#{messageId,javaType=String}
	          ,#{emailId,javaType=String}
	          ,#{bindType,javaType=String}
	          ,SYSDATE()
	          ,SYSDATE()
	          ,#{createUser,javaType=String}
	          ,SYSDATE()
	          ,#{createUser,javaType=String}
	          ,#{oprateType,javaType=String}
	          )          
     </insert>
     <!-- 更新自动化规则 -->
     <update id="updateRule" parameterType="com.xuyurepos.vo.autorule.AutoRuleManagerDTO">
     	update XUYU_RULE_INFO set INVALID='N',END_DATE=SYSDATE(),UPDATE_USER=#{createUser,javaType=String},UPDATE_DATE=SYSDATE() WHERE ID=#{id}
     </update>
     <!-- 暂停规则执行 -->
     <update id="stopRule" parameterType="String">
          	update XUYU_RULE_INFO set INVALID='N',END_DATE=SYSDATE(),UPDATE_USER=#{createUser,javaType=String},UPDATE_DATE=SYSDATE() WHERE ID=#{id}
     </update>
     <resultMap type="com.xuyurepos.vo.autorule.AutoRuleManagerDTO" id="autoRule">
		<!-- column存数据库中的属性   property存javabean中数据-->
		<id column="ID" property="id" jdbcType="VARCHAR"/>
		<result column="RULE_ID" property="ruleId" jdbcType="VARCHAR"/>
		<result column="RULE_NAME" property="ruleName" jdbcType="VARCHAR"/>
		<result column="RULE_TYPE" property="ruleType" jdbcType="VARCHAR"/>
		<result column="RULE_VALUE" property="rate" jdbcType="DECIMAL"/>
		<result column="GPRS" property="gprs" jdbcType="DECIMAL"/>
		<result column="DAYS" property="days" jdbcType="DECIMAL"/>
		<result column="OWNER" property="ownerId" jdbcType="VARCHAR"/>
		<result column="OWNER_NAME" property="ownerName" jdbcType="VARCHAR"/>
		<result column="ACCESS_NUM" property="accessNums" jdbcType="VARCHAR"/>
		<result column="ACCESS_NUM_START" property="accessNumStart" jdbcType="VARCHAR"/>
		<result column="ACCESS_NUM_END" property="accessNumEnd" jdbcType="VARCHAR"/>
		<result column="MESSAGE_PHONE" property="messageId" jdbcType="VARCHAR"/>
		<result column="MESSAGE_MAIL" property="emailId" jdbcType="VARCHAR"/>
		<result column="AFFECT_RANGE" property="bindType" jdbcType="VARCHAR"/>
		<result column="CREATE_USER" property="createUser" jdbcType="VARCHAR"/>
		<result column="CREATE_DATE" property="createDate" jdbcType="TIMESTAMP"/>
		<result column="UPDATE_USER" property="updateUser" jdbcType="VARCHAR"/>
		<result column="UPDATE_DATE" property="updateDate" jdbcType="TIMESTAMP"/>
		<result column="OPRATE_TYPE" property="oprateType" jdbcType="VARCHAR"/>
		<result column="INVALID" property="isValidate" jdbcType="VARCHAR"/>
	</resultMap>
	<!-- 查询规则详情 -->
	<select id="getRuleInfo" parameterType="String" resultMap="autoRule">
		select ID,RULE_ID,RULE_NAME,RULE_TYPE,RULE_TYPE,RULE_VALUE,GPRS,DAYS,OWNER,OWNER_NAME,ACCESS_NUM,ACCESS_NUM_START,ACCESS_NUM_END,
		MESSAGE_PHONE,MESSAGE_MAIL,AFFECT_RANGE 
		from XUYU_RULE_INFO where id=#{id}
	</select>
	
    <sql id="sql_count">
        SELECT COUNT(*)
    </sql>
    
    <sql id="sql_select">
        SELECT *
    </sql>
    
    <sql id="sql_where">
        FROM XUYU_RULE_INFO
        <where>
            <if test="queryObj != null">
                <if test="queryObj.ruleName != null and queryObj.ruleName != ''">
                    AND RULE_NAME like 
                    '%${queryObj.ruleName}%'
                </if>
                <if test="queryObj.startDate != null and queryObj.startDate != ''">
                	AND START_DATE  &gt;= str_to_date(#{queryObj.startDate},'%Y-%m-%d')
                </if>
                <if test="queryObj.endDate != null and queryObj.endDate != ''">
                    AND START_DATE  &lt;= str_to_date(#{queryObj.endDate},'%Y-%m-%d')
                </if>
                 <if test="queryObj.isValidate != null and queryObj.isValidate != ''">
                    AND INVALID =#{queryObj.isValidate}
                </if>
                 
            </if>
        </where>
    </sql>
    
   <select id="selectRuleListWithPage" parameterType="com.xuyurepos.common.page.PageModel" resultMap="autoRule">
        <include refid="sql_select"></include>
        <include refid="sql_where"></include>
        <if test="pageNumber != null and  pageSize!= null">
            limit #{startRow},#{pageSize}
        </if>
    </select>

    <select id="selectRuleCountWithPage" parameterType="com.xuyurepos.common.page.PageModel" resultType="Integer">
        <include refid="sql_count"></include>
        <include refid="sql_where"></include>
    </select>
    
    <sql id="sql_select_log">
        SELECT  a.ID id,
				a.ACCESS_NUM accessNum, 
				a.ICCID iccid,      
				a.IMSI imsi,     
				a.PROVIDER provider,   
				a.OWNER_PLACE ownerPlace, 
				a.WORKING_CONDITION workingCondition,
				a.OWNER ownerId, 
				a.IS_DEAL isDeal,
				a.OPERATE_TYPE operateType, 
				a.CREATE_USER ,
				a.UPDATE_USER ,
				a.CREATE_DATE ,
				a.UPDATE_DATE, 
				a.RULE_ID ruleId,
			    b.RULE_NAME ruleName
    </sql>
    
	
    <sql id="sql_where_log">
        from XUYU_CONTENT_CARD_RULE_RESULT a,XUYU_RULE_INFO b
        <where>  a.RULE_ID=b.RULE_ID
            <if test="queryObj != null">
                <if test="queryObj.ruleName != null and queryObj.ruleName != ''">
                    AND b.RULE_NAME like 
                    '%${queryObj.ruleName}%'
                </if>
                <if test="queryObj.startDate != null and queryObj.startDate != ''">
                	AND UPDATE_DATE  &gt;= str_to_date(#{queryObj.startDate},'%Y-%m-%d')
                </if>
                <if test="queryObj.endDate != null and queryObj.endDate != ''">
                    AND UPDATE_DATE  &lt;= str_to_date(#{queryObj.endDate},'%Y-%m-%d')
                </if>
                 <if test="queryObj.operateType != null and queryObj.operateType != ''">
                    AND operate_Type =#{queryObj.operateType}
                </if>
                 <if test="queryObj.isDeal != null and queryObj.isDeal!= ''">
                    AND INVALID =#{queryObj.isDeal}
                </if>
                 
            </if>
        </where>
    </sql>
    
   <select id="selectRuleLogWithPage" parameterType="com.xuyurepos.common.page.PageModel" resultType="com.xuyurepos.vo.autorule.AutoRuleLogDTO">
        <include refid="sql_select_log"></include>
        <include refid="sql_where_log"></include>
        <if test="pageNumber != null and  pageSize!= null">
            limit #{startRow},#{pageSize}
        </if>
    </select>

    <select id="selectRuleLogCountWithPage" parameterType="com.xuyurepos.common.page.PageModel" resultType="Integer">
        <include refid="sql_count"></include>
        <include refid="sql_where_log"></include>
    </select>
    
  
    <sql id="sql_select_yes">
        SELECT  a.ID id,
				a.ACCESS_NUM accessNum, 
				a.ICCID iccid,      
				a.IMSI imsi,     
				a.PROVIDER provider,   
				a.OWNER_PLACE ownerPlace, 
				a.AGENCY agency,
				a.WORKING_CONDITION workingCondition,
				a.OWNER ownerId, 
				IFNULL(a.USE_GPRS-IFNULL((select b.USE_GPRS from  XUYU_CONTENT_CARD_INFO_IMPORT b 
							where a.ACCESS_NUM=b.ACCESS_NUM
							and b.DOWNLOAD_DATE=
									DATE_ADD(a.DOWNLOAD_DATE,INTERVAL -1 day) LIMIT 1),0),0) gprsYesterDay,
				date_format(DATE_ADD(a.DOWNLOAD_DATE,INTERVAL -1 day),'%Y-%m-%d') queryDate
    </sql>
    
	
    <sql id="sql_where_yes">
        from XUYU_CONTENT_CARD_INFO_IMPORT a 
        <where>  DOWNLOAD_DATE=IFNULL(DATE_ADD(date_format(#{queryObj.queryDate},'%Y-%m-%d'),INTERVAL+1 day),
										DATE_ADD(CURRENT_DATE,INTERVAL -1 day))
            <if test="queryObj != null">
                <if test="queryObj.provider != null and queryObj.provider != ''">
                    AND PROVIDER=#{queryObj.provider}
                </if>
                 <if test="queryObj.ownerPlace != null and queryObj.ownerPlace != ''">
                    AND OWNER_PLACE=#{queryObj.ownerPlace}
                </if>
                 <if test="queryObj.agency != null and queryObj.agency != ''">
                    AND AGENCY=#{queryObj.agency}
                </if>
                <if test="queryObj.ownerId != null and queryObj.ownerId != ''">
                	AND OWNER= #{ownerId}
                </if>
                <if test="queryObj.queryDate != null and queryObj.queryDate != ''">
                    AND DOWNLOAD_DATE=IFNULL(DATE_ADD(date_format(#{queryObj.queryDate},'%Y-%m-%d'),INTERVAL+1 day),
										DATE_ADD(CURRENT_DATE,INTERVAL -1 day))
                </if>
                 <if test="queryObj.accessNum != null and queryObj.accessNum != ''">
                    AND ACCESS_NUM =#{queryObj.accessNum}
                </if>
                 <if test="queryObj.gprsYesterday != null and queryObj.gprsYesterday!= ''">
                    having gprsYesterDay &gt;= #{queryObj.gprsYesterday}
                </if>
                 
            </if>
        </where>
    </sql>
    
   <select id="selectRuleYesWithPage" parameterType="com.xuyurepos.common.page.PageModel" resultType="com.xuyurepos.vo.autorule.AutoRuleLogDTO">
        <include refid="sql_select_yes"></include>
        <include refid="sql_where_yes"></include>
        <if test="pageNumber != null and  pageSize!= null">
            limit #{startRow},#{pageSize}
        </if>
    </select>

    <select id="selectRuleYesCountWithPage" parameterType="com.xuyurepos.common.page.PageModel" resultType="Integer">
         select count(1) from (
        <include refid="sql_select_yes"></include>
        <include refid="sql_where_yes"></include>
        ) s
    </select>
    
    <select id="selectDeadLineWithPage" parameterType="com.xuyurepos.common.page.PageModel" resultType="com.xuyurepos.vo.autorule.AutoRuleLogDTO">
        SELECT
			a.ID id,
			a.ACCESS_NUM accessNum,
			a.ICCID iccid,
			a.IMSI imsi,
			a.PROVIDER provider,
			a.OWNER_PLACE ownerPlace,
			a.AGENCY agency,
			a.WORKING_CONDITION workingCondition,
			a.OWNER ownerId,
			a.DEADLINE_DATE deadLineDate,
			a.WAIT_DATE waitDate,
			a.REAL_DEADLINE realDeadLineDate
		FROM
			XUYU_CONTENT_CARD_INFO a where 1=1
		<if test="queryObj != null">
               <if test="queryObj.provider != null and queryObj.provider != ''">
                   AND PROVIDER=#{queryObj.provider}
               </if>
                <if test="queryObj.ownerPlace != null and queryObj.ownerPlace != ''">
                   AND OWNER_PLACE=#{queryObj.ownerPlace}
               </if>
                <if test="queryObj.agency != null and queryObj.agency != ''">
                   AND AGENCY=#{queryObj.agency}
               </if>
               <if test="queryObj.ownerId != null and queryObj.ownerId != ''">
               	AND OWNER= #{ownerId}
               </if>
               <if test="queryObj.accessNum != null and queryObj.accessNum != ''">
                   AND ACCESS_NUM =#{queryObj.accessNum}
               </if>
               <if test="queryObj.startDDate != null and queryObj.startDDate != ''">
               	   AND DEADLINE_DATE  &gt;= str_to_date(#{queryObj.startDDate},'%Y-%m-%d')
               </if>
               <if test="queryObj.endDDate != null and queryObj.endDDate != ''">
                   AND DEADLINE_DATE  &lt;= str_to_date(#{queryObj.endDDate},'%Y-%m-%d')
               </if>
                <if test="queryObj.startWDate != null and queryObj.startWDate != ''">
               	   AND WAIT_DATE  &gt;= str_to_date(#{queryObj.startWDate},'%Y-%m-%d')
               </if>
               <if test="queryObj.endWDate != null and queryObj.endWDate != ''">
                   AND WAIT_DATE  &lt;= str_to_date(#{queryObj.endWDate},'%Y-%m-%d')
               </if>
                <if test="queryObj.startRWDate != null and queryObj.startRWDate != ''">
               	   AND REAL_DEADLINE  &gt;= str_to_date(#{queryObj.startDDate},'%Y-%m-%d')
               </if>
               <if test="queryObj.endRWDate != null and queryObj.endRWDate != ''">
                   AND REAL_DEADLINE  &lt;= str_to_date(#{queryObj.endRWDate},'%Y-%m-%d')
               </if>
         </if>
        <if test="pageNumber != null and  pageSize!= null">
            limit #{startRow},#{pageSize}
        </if>
    </select>

    <select id="selectDeadLCountWithPage" parameterType="com.xuyurepos.common.page.PageModel" resultType="Integer">
         SELECT
			count(1)
		FROM
			XUYU_CONTENT_CARD_INFO a where 1=1
		<if test="queryObj != null">
               <if test="queryObj.provider != null and queryObj.provider != ''">
                   AND PROVIDER=#{queryObj.provider}
               </if>
                <if test="queryObj.ownerPlace != null and queryObj.ownerPlace != ''">
                   AND OWNER_PLACE=#{queryObj.ownerPlace}
               </if>
                <if test="queryObj.agency != null and queryObj.agency != ''">
                   AND AGENCY=#{queryObj.agency}
               </if>
               <if test="queryObj.ownerId != null and queryObj.ownerId != ''">
               	AND OWNER= #{ownerId}
               </if>
               <if test="queryObj.accessNum != null and queryObj.accessNum != ''">
                   AND ACCESS_NUM =#{queryObj.accessNum}
               </if>
               <if test="queryObj.startDDate != null and queryObj.startDDate != ''">
               	   AND DEADLINE_DATE  &gt;= str_to_date(#{queryObj.startDDate},'%Y-%m-%d')
               </if>
               <if test="queryObj.endDDate != null and queryObj.endDDate != ''">
                   AND DEADLINE_DATE  &lt;= str_to_date(#{queryObj.endDDate},'%Y-%m-%d')
               </if>
                <if test="queryObj.startWDate != null and queryObj.startWDate != ''">
               	   AND WAIT_DATE  &gt;= str_to_date(#{queryObj.startWDate},'%Y-%m-%d')
               </if>
               <if test="queryObj.endWDate != null and queryObj.endWDate != ''">
                   AND WAIT_DATE  &lt;= str_to_date(#{queryObj.endWDate},'%Y-%m-%d')
               </if>
                <if test="queryObj.startRWDate != null and queryObj.startRWDate != ''">
               	   AND REAL_DEADLINE  &gt;= str_to_date(#{queryObj.startDDate},'%Y-%m-%d')
               </if>
               <if test="queryObj.endRWDate != null and queryObj.endRWDate != ''">
                   AND REAL_DEADLINE  &lt;= str_to_date(#{queryObj.endRWDate},'%Y-%m-%d')
               </if>
         </if>
    </select>

	 <select id="selectGprsMonthWithPage" parameterType="com.xuyurepos.common.page.PageModel" resultType="com.xuyurepos.vo.autorule.AutoRuleLogDTO">
        select * from (SELECT
			a.PROVIDER provider,
			a.OWNER_PLACE ownerPlace,
			c.ORG_NAME agency,
			b.OWNER_NAME as ownerName,
			a.COMNO_NAME comboName,
			sum(a.USE_GPRS) useGprs,
			sum(a.COMNO_NAME) totalGprs,
			sum(a.REMAIN_GPS) remainGprs,
			round(sum(a.USE_GPRS)/sum(a.COMNO_NAME),4)*100 useGprsPercent,
			count(1) activeCount 
			
		FROM
			XUYU_CONTENT_CARD_INFO a ,XUYU_OWNER_INFO b,SYSTEM_AUTH_ORG c
		WHERE
			a.TOTAL_GPRS &gt; 0
		AND a.ACTIVATE_DATE is not null
	    AND a.`OWNER`=b.ID
		AND a.AGENCY=c.ID
		<if test="queryObj != null">
           <if test="queryObj.provider != null and queryObj.provider != ''">
               AND a.PROVIDER=#{queryObj.provider}
           </if>
	        <if test="queryObj.ownerPlace != null and queryObj.ownerPlace != ''">
	           AND a.OWNER_PLACE=#{queryObj.ownerPlace}
	       </if>
	        <if test="queryObj.agency != null and queryObj.agency != ''">
	           AND a.AGENCY=#{queryObj.agency}
	       </if>
	       <if test="queryObj.comboName != null and queryObj.comboName != ''">
	           AND a.COMNO_NAME= #{queryObj.comboName}
	       </if>
       </if>
		GROUP BY
			a.PROVIDER,
			a.OWNER_PLACE,
			a.AGENCY,
			a.COMNO_NAME,
			a.OWNER,
			b.id
		having remainGprs &gt; 0
		) s 
        <if test="pageNumber != null and  pageSize!= null">
            limit #{startRow},#{pageSize}
        </if>
    </select>

    <select id="selectGprsMonthCountWithPage" parameterType="com.xuyurepos.common.page.PageModel" resultType="Integer">
         select count(1) from (SELECT
			a.PROVIDER provider,
			a.OWNER_PLACE ownerPlace,
			c.ORG_NAME agency,
			b.OWNER_NAME as ownerName,
			a.COMNO_NAME comboName,
			sum(a.USE_GPRS) useGprs,
			sum(a.COMNO_NAME) totalGprs,
			sum(a.REMAIN_GPS) remainGprs,
			round(sum(a.USE_GPRS)/sum(a.COMNO_NAME),4)*100 useGprsPercent,
			count(1) activeCount 
		FROM
			XUYU_CONTENT_CARD_INFO a ,XUYU_OWNER_INFO b,SYSTEM_AUTH_ORG c
		WHERE
			a.TOTAL_GPRS &gt; 0
		AND a.ACTIVATE_DATE is not null
		AND a.`OWNER`=b.ID
		AND a.AGENCY=c.ID
		<if test="queryObj != null">
            <if test="queryObj.provider != null and queryObj.provider != ''">
               AND a.PROVIDER=#{queryObj.provider}
            </if>
	        <if test="queryObj.ownerPlace != null and queryObj.ownerPlace != ''">
	           AND a.OWNER_PLACE=#{queryObj.ownerPlace}
	       </if>
	        <if test="queryObj.agency != null and queryObj.agency != ''">
	           AND a.AGENCY=#{queryObj.agency}
	       </if>
	       <if test="queryObj.comboName != null and queryObj.comboName != ''">
	           AND a.COMNO_NAME= #{queryObj.comboName}
	       </if>
       </if>
		GROUP BY
			a.PROVIDER,
			a.OWNER_PLACE,
			a.AGENCY,
			a.COMNO_NAME,
			a.OWNER,
			b.id
		having remainGprs &gt; 0
		) s 
    </select>
    
    <select id="selectGprsCompanyWithPage" parameterType="com.xuyurepos.common.page.PageModel" resultType="com.xuyurepos.vo.autorule.AutoRuleLogDTO">
			SELECT
				provider,
				ownerPlace,
				realComboType,
				count( 1 ) cardNumTot,
				sum( cardNumActive) cardNumActive,
				sum( cardNumTest  ) cardNumTest,
				sum( cardNumWait  ) cardNumWait,
				sum( cardNumStop  ) cardNumStop,
				sum( cardNumActive * realComboType ) useGprsActive,
				sum( cardNumTest * realComboType ) useGprsTest,
				sum( cardNumWait * realComboType ) useGprsWait,
				sum( cardNumStop * realComboType ) useGprsStop,
				sum( useGprs ) useGprs,
				sum( realComboType ) totalGprs,
				round(sum( useGprs )/sum( realComboType ),4)*100 useGprsPercent
			FROM
				(
			SELECT
				a.PROVIDER provider,
				a.OWNER_PLACE ownerPlace,
				a.REAL_COMBOTYPE realComboType,
				(
			CASE
				WHEN (
				REAL_ACTIVATE IS NOT NULL 
				AND ( REAL_TEST_TYPE IS NULL OR DATE_ADD( REAL_ACTIVATE, INTERVAL + REAL_TEST_TYPE MONTH ) &gt;= CURRENT_DATE ) 
				AND WORKING_CONDITION NOT IN ( '02', 'RETIRED', '5' ) 
				) THEN
				1 ELSE 0 
			END 
				) cardNumActive,
				(
			CASE
				WHEN (
				REAL_ACTIVATE IS NOT NULL 
				AND REAL_TEST_TYPE IS NOT NULL 
				AND DATE_ADD( REAL_ACTIVATE, INTERVAL + REAL_TEST_TYPE MONTH ) &lt; CURRENT_DATE 
				AND WORKING_CONDITION NOT IN ( '02', 'RETIRED', '5' ) 
				) THEN
				1 ELSE 0 
			END 
				) cardNumTest,
				(
			CASE
				WHEN (
				REAL_ACTIVATE IS NULL 
				AND REAL_WAIT_TYPE IS NOT NULL 
				AND DATE_ADD( REAL_ESTABLISH, INTERVAL + REAL_WAIT_TYPE MONTH ) &lt; CURRENT_DATE 
				AND WORKING_CONDITION NOT IN ( '02', 'RETIRED', '5' ) 
				) THEN
				1 ELSE 0 
			END 
				) cardNumWait,
				( CASE WHEN ( WORKING_CONDITION IN ( '02', 'RETIRED', '5' ) ) THEN 1 ELSE 0 END ) cardNumStop,
				USE_GPRS useGprs 
			FROM
				XUYU_CONTENT_CARD_INFO a where 1=1
				<if test="queryObj != null">
					<if test="queryObj.provider!= null and queryObj.provider!= ''">
		           		AND PROVIDER=#{queryObj.provider}
		            </if>
			        <if test="queryObj.ownerPlace != null and queryObj.ownerPlace != ''">
			           AND OWNER_PLACE=#{queryObj.ownerPlace}
			       </if>
			        <if test="queryObj.agency != null and queryObj.agency != ''">
			           AND AGENCY=#{queryObj.agency}
			       </if>
			       <if test="queryObj.ownerId != null and queryObj.ownerId != ''">
			       	AND OWNER= #{ownerId}
			       </if>
       			</if>
				) s 
			GROUP BY
				provider,
				ownerPlace,
				realComboType
		<if test="pageNumber != null and  pageSize!= null">
            limit #{startRow},#{pageSize}
        </if>
    </select>
    <select id="selectGprsCompanyCountWithPage" parameterType="com.xuyurepos.common.page.PageModel" resultType="Integer">
			SELECT
				count( 1 ) 
			FROM
				(
			SELECT
				a.PROVIDER provider,
				a.OWNER_PLACE ownerPlace,
				a.REAL_COMBOTYPE realComboType,
				count(1)
			FROM
				XUYU_CONTENT_CARD_INFO a where 1=1
				<if test="queryObj != null">
					<if test="queryObj.provider!= null and queryObj.provider!= ''">
		           		AND PROVIDER=#{queryObj.provider}
		            </if>
			        <if test="queryObj.ownerPlace != null and queryObj.ownerPlace != ''">
			           AND OWNER_PLACE=#{queryObj.ownerPlace}
			       </if>
			        <if test="queryObj.agency != null and queryObj.agency != ''">
			           AND AGENCY=#{queryObj.agency}
			       </if>
			       <if test="queryObj.ownerId != null and queryObj.ownerId != ''">
			       	AND OWNER= #{ownerId}
			       </if>
       			</if>
	       		GROUP BY provider,ownerPlace,realComboType
				) s 
    </select>
    
    
    <select id="selectComboDiffWithPage" parameterType="com.xuyurepos.common.page.PageModel" resultType="com.xuyurepos.vo.autorule.AutoRuleLogDTO">
         SELECT
			a.ID id,
			a.ACCESS_NUM accessNum,
			a.ICCID iccid,
			a.IMSI imsi,
			a.PROVIDER provider,
			a.OWNER_PLACE ownerPlace,
			a.AGENCY agency,
			a.WORKING_CONDITION workingCondition,
			a.OWNER ownerId,
			a.COMBO_TYPE comboType,
			a.USE_GPRS useGprs,
			date_format(SYSDATE(),'%Y%m') queryDate
		FROM
			XUYU_CONTENT_CARD_INFO a where 1=1
		<if test="queryObj != null">
               <if test="queryObj.provider != null and queryObj.provider != ''">
                   AND PROVIDER=#{queryObj.provider}
               </if>
                <if test="queryObj.ownerPlace != null and queryObj.ownerPlace != ''">
                   AND OWNER_PLACE=#{queryObj.ownerPlace}
               </if>
                <if test="queryObj.agency != null and queryObj.agency != ''">
                   AND AGENCY=#{queryObj.agency}
               </if>
               <if test="queryObj.ownerId != null and queryObj.ownerId != ''">
               	AND OWNER= #{ownerId}
               </if>
               <if test="queryObj.accessNum != null and queryObj.accessNum != ''">
                   AND ACCESS_NUM =#{queryObj.accessNum}
               </if>
               <if test="queryObj.comboType != null and queryObj.comboType != ''">
                   AND COMBO_TYPE =#{queryObj.comboType}
               </if>
                <if test="queryObj.useGprs != null and queryObj.useGprs != ''">
               	   AND (COMBO_TYPE-USE_GPRS)  &gt;= #{queryObj.useGprs}
               </if>
         </if>
         <if test="pageNumber != null and  pageSize!= null">
            limit #{startRow},#{pageSize}
        </if>
    </select>
    <select id="selectComboDiffCountWithPage" parameterType="com.xuyurepos.vo.autorule.AutoRuleLogDTO" resultType="Integer">
         SELECT
			count(1)
		FROM
			XUYU_CONTENT_CARD_INFO a where 1=1
		<if test="queryObj != null">
               <if test="queryObj.provider != null and queryObj.provider != ''">
                   AND PROVIDER=#{queryObj.provider}
               </if>
                <if test="queryObj.ownerPlace != null and queryObj.ownerPlace != ''">
                   AND OWNER_PLACE=#{queryObj.ownerPlace}
               </if>
                <if test="queryObj.agency != null and queryObj.agency != ''">
                   AND AGENCY=#{queryObj.agency}
               </if>
               <if test="queryObj.ownerId != null and queryObj.ownerId != ''">
               	AND OWNER= #{ownerId}
               </if>
               <if test="queryObj.accessNum != null and queryObj.accessNum != ''">
                   AND ACCESS_NUM =#{queryObj.accessNum}
               </if>
               <if test="queryObj.comboType != null and queryObj.comboType != ''">
                   AND COMBO_TYPE =#{queryObj.comboType}
               </if>
                <if test="queryObj.useGprs != null and queryObj.useGprs != ''">
               	   AND (COMBO_TYPE-USE_GPRS)  &gt;= #{queryObj.useGprs}
               </if>
         </if>
    </select>
</mapper>