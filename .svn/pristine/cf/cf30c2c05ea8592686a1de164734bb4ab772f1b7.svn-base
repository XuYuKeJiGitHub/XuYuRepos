package com.xuyurepos.service.impl.payment;

import java.math.BigDecimal;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;

import org.apache.log4j.Logger;
import org.springframework.beans.BeanUtils;
import org.springframework.stereotype.Service;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import com.xuyurepos.common.constants.SystemConstants;
import com.xuyurepos.common.exception.CustomException;
import com.xuyurepos.common.log.LoggerFactory;
import com.xuyurepos.dao.manager.XuyuContentCardInfoDao;
import com.xuyurepos.dao.payment.XuyuRechargeDao;
import com.xuyurepos.entity.manager.XuyuContentCardInfo;
import com.xuyurepos.entity.payment.XuyuRecharge;
import com.xuyurepos.entity.system.SystemUser;
import com.xuyurepos.service.payment.XuyuRechargeService;
import com.xuyurepos.service.system.SystemOrgService;
import com.xuyurepos.vo.payment.XuyuRechargeVo;
import com.xuyurepos.vo.system.SystemOrgVo;
/**
 * 充值处理实现类
 * @author yangfei
 *
 */
@Service
public class XuyuRechargeServiceImpl implements XuyuRechargeService{
	Logger logger=LoggerFactory.getInstance().getLogger(XuyuRechargeServiceImpl.class);
	
	@Resource
	private  XuyuRechargeDao xuyuRechargeDao;
	
	@Resource
	private SystemOrgService systemOrgService;
	
	@Resource
	private XuyuContentCardInfoDao xuyuContentCardInfoDao;
    
	/**
	 * 保存方法
	 * @throws CustomException 
	 */
	@Override
	public void saveInfo(XuyuRechargeVo xuyuRechargeVo) throws CustomException {
		logger.info(" saveInfo(XuyuRechargeVo xuyuRechargeVo) XuyuRechargeServiceImpl start");
		logger.info("xuyuRechargeVo:"+xuyuRechargeVo.toString());
		if(xuyuRechargeVo.getId()!=null&&!SystemConstants.STRINGEMPTY.equals(xuyuRechargeVo.getId())){
			edit(xuyuRechargeVo);
		}else{
			add(xuyuRechargeVo);
		}
		logger.info(" saveInfo(XuyuRechargeVo xuyuRechargeVo) XuyuRechargeServiceImpl end");
	}
    
	/**
	 * 修改数据
	 * @param xuyuRechargeVo
	 * @return
	 */
	private XuyuRecharge edit(XuyuRechargeVo xuyuRechargeVo) {
		XuyuRecharge xuyuRecharge=xuyuRechargeDao.find(Integer.valueOf(xuyuRechargeVo.getId()));
		if(xuyuRecharge!=null){
			BeanUtils.copyProperties(xuyuRechargeVo, xuyuRecharge);
			xuyuRechargeDao.update(xuyuRecharge);
		}
		return xuyuRecharge;
	}
    
	/**
	 * 添加数据
	 * @param xuyuRechargeVo
	 * @return
	 * @throws CustomException 
	 */
	@SuppressWarnings({ "rawtypes", "unchecked" })
	private void add(XuyuRechargeVo xuyuRechargeVo) throws CustomException {
		try {
			XuyuRecharge xuyuRecharge=null;
			HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
			SystemUser systemUser=(SystemUser) request.getSession().getAttribute("systemUser");
			String orgId=systemUser.getOrgId();
			// 查找机构信息
			SystemOrgVo systemOrgVo=systemOrgService.find(orgId);
			// 判断是否为卡段充值
			if(SystemConstants.STRING_YES.equals(xuyuRechargeVo.getYesNo())){
				if(systemOrgVo.getOrgLevel().equals("1")){
					int result=xuyuContentCardInfoDao.findCount(xuyuRechargeVo.getAccessNumStart(), xuyuRechargeVo.getAccessNumEnd());
					logger.info("result:"+result);
					if(result>100000){
						throw new CustomException("一次充值最多100000张卡");
					}else{
						Calendar calendar = Calendar.getInstance();
						calendar.setTime(new Date());
						xuyuRecharge=new XuyuRecharge();
						xuyuRechargeVo.setIsPay(SystemConstants.STRING_YES);
						xuyuRechargeVo.setCreateUser(systemUser.getUserName());
						xuyuRechargeVo.setCreateOrg(systemUser.getOrgId());
						xuyuRechargeVo.setCreateDate(calendar.getTime());
						HashMap map=new HashMap();
						map.put("record", xuyuRechargeVo);
						xuyuRechargeDao.insertAccs(map);
					}
				}else{
					throw new CustomException("超出当前用户权限，只有总部用户才能充值");
				}
			}else{
				if(systemOrgVo.getOrgLevel().equals("1")){
					String accessNums=xuyuRechargeVo.getAccessNums();
					if(accessNums!=null&&!SystemConstants.STRINGEMPTY.equals(accessNums)){
						Calendar calendar = Calendar.getInstance();
						calendar.setTime(new Date());
						String[] accessNumStr=accessNums.split(";");
						for (int i = 0; i < accessNumStr.length; i++) {
							XuyuContentCardInfo xuyuContentCardInfo=xuyuContentCardInfoDao.find(accessNumStr[i]);
							xuyuRecharge=new XuyuRecharge();
							// 设置后台充值
							BigDecimal money=xuyuContentCardInfo.getUnitCost().multiply(BigDecimal.valueOf(Long.valueOf(xuyuRechargeVo.getChargeCost())));
							if(xuyuContentCardInfo.getComboType()==null||SystemConstants.STRINGEMPTY.equals(xuyuContentCardInfo.getComboType())){
								throw new CustomException("还未设置套餐，请先设置套餐");
							}
							if(xuyuContentCardInfo.getComnoName()==null||SystemConstants.STRINGEMPTY.equals(xuyuContentCardInfo.getComnoName())){
								throw new CustomException("还未设置套餐，请先设置套餐");
							}
							BigDecimal totalGprs=BigDecimal.valueOf(Long.valueOf(xuyuContentCardInfo.getComboType())).multiply(BigDecimal.valueOf(Long.valueOf(xuyuContentCardInfo.getComnoName()))).multiply(BigDecimal.valueOf(Long.valueOf(xuyuRechargeVo.getChargeCost())));
							xuyuRecharge.setAccessNum(xuyuContentCardInfo.getAccessNum());
							xuyuRecharge.setComboType(xuyuContentCardInfo.getComboType());
							xuyuRecharge.setComnoName(xuyuContentCardInfo.getComnoName());
							xuyuRecharge.setTotalGprs(totalGprs);
							xuyuRecharge.setPrice(xuyuContentCardInfo.getUnitCost());
							xuyuRecharge.setMoney(money);
							xuyuRecharge.setIsPay(SystemConstants.STRING_YES);
							xuyuRecharge.setCreateUser(systemUser.getUserName());
							xuyuRecharge.setCreateOrg(systemUser.getOrgId());
							xuyuRecharge.setCreateDate(calendar.getTime());
							xuyuRechargeDao.insert(xuyuRecharge);
							// 设置套餐总量
							xuyuContentCardInfo.setTotalGprs(totalGprs);
							xuyuContentCardInfoDao.update(xuyuContentCardInfo);
						}
					}else{
						throw new CustomException("非卡段充值，请选择需要充值的数据");
					}
				}else{
					throw new CustomException("超出当前用户权限，只有总部用户才能充值");
				}
			}
		} catch (Exception e) {
			e.printStackTrace();
			throw e;
		}
	}

}
