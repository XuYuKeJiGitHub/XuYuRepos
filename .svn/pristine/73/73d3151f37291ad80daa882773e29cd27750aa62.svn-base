package com.xuyurepos.serviceImpl.system;

import java.util.List;

import javax.annotation.Resource;

import org.apache.log4j.Logger;
import org.springframework.beans.BeanUtils;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.xuyurepos.common.constants.SystemConstants;
import com.xuyurepos.common.log.LoggerFactory;
import com.xuyurepos.common.page.PageModel;
import com.xuyurepos.common.util.StringUtil;
import com.xuyurepos.dao.system.SystemOrgDao;
import com.xuyurepos.entity.system.SystemOrg;
import com.xuyurepos.service.system.SystemOrgService;
import com.xuyurepos.vo.system.SystemOrgVo;

@Service
@Transactional
public class SystemOrgServiceImpl implements SystemOrgService{
	
	Logger log=LoggerFactory.getInstance().getLogger(SystemOrgServiceImpl.class);
	
	@Resource
	private SystemOrgDao systemOrgDao;
    
	/**
	 * 分页查询
	 */
	@SuppressWarnings({ "unchecked", "rawtypes" })
	@Override
	public void findList(PageModel pageModel) {
		pageModel.setRows(systemOrgDao.selectUserListWithPage(pageModel));
	    pageModel.setTotal(systemOrgDao.selectUserCountWithPage(pageModel));
	}
    
	/**
	 * 删除
	 */
	@Override
	public void delete(String ids) {
		if(!StringUtil.isEmpty(ids)){
			String[] idsStr=ids.split(SystemConstants.STRING_SENT);
			for (int i = 0; i < idsStr.length; i++) {
				if(!StringUtil.isEmpty(idsStr[i])){
					Integer id=Integer.valueOf(idsStr[i]);
					SystemOrg systemOrg=systemOrgDao.find(id);
					if(systemOrg!=null){
						systemOrgDao.del(id);
					}
				}
			}
		}
	}
    
	/**
	 * 保存机构数据
	 */
	@Override
	public SystemOrg saveInfo(SystemOrgVo systemOrgVo) {
		log.info("SystemOrgVo:"+systemOrgVo.toString());
		SystemOrg systemOrg=new SystemOrg();
		if(systemOrgVo!=null&&SystemConstants.STRINGEMPTY.equals(systemOrgVo.getId())){
			BeanUtils.copyProperties(systemOrgVo, systemOrg);
			log.info("systemOrg:"+systemOrg.toString());
			add(systemOrg);
		}else{
			systemOrg=edit(systemOrgVo);
		}
		return systemOrg;
	}
    
	/**
	 * 编辑
	 * @param systemOrgVo
	 * @return
	 */
	private SystemOrg edit(SystemOrgVo systemOrgVo) {
		SystemOrg org=systemOrgDao.find(Integer.valueOf(systemOrgVo.getId()));
		if(org!=null){
			BeanUtils.copyProperties(systemOrgVo, org);
			log.info("SystemOrg:"+org.toString());
			// 判定
			if("0".equals(org.getUpOrgId())){
				org.setOrgLevel("1");
				List<SystemOrg> list=systemOrgDao.getList(SystemConstants.STRINGEMPTY+org.getId());
				if(list==null){
					org.setIsLeaf("y");
				}else{
					org.setIsLeaf("n");
				}
				systemOrgDao.update(org);
			}else{
				systemOrgDao.update(org);
				// 把父类的是否子节点改成否
				SystemOrg father=systemOrgDao.find(Integer.valueOf(org.getUpOrgId()));
				father.setIsLeaf("n");
				systemOrgDao.update(father);
				org.setOrgLevel(SystemConstants.STRINGEMPTY+(Integer.valueOf(father.getOrgLevel())+1));
				// 查询当前机构是否有子节点
				List<SystemOrg> list=systemOrgDao.getList(SystemConstants.STRINGEMPTY+org.getId());
				if(list==null){
					org.setIsLeaf("y");
				}else{
					org.setIsLeaf("n");
				}
				systemOrgDao.update(org);
			}
		}
		return org;
	}
    
	/**
	 * 添加
	 * @param systemOrg
	 * @return
	 */
	private SystemOrg add(SystemOrg systemOrg) {
		// 判定
		if("0".equals(systemOrg.getUpOrgId())){
			systemOrg.setOrgLevel("1");
			systemOrg.setIsLeaf("y");
			systemOrgDao.insert(systemOrg);
		}else{
			// 把父类的是否子节点改成否
			SystemOrg father=systemOrgDao.find(Integer.valueOf(systemOrg.getUpOrgId()));
			father.setIsLeaf("n");
			systemOrgDao.update(father);
			systemOrg.setOrgLevel(SystemConstants.STRINGEMPTY+(Integer.valueOf(father.getOrgLevel())+1));
			systemOrg.setIsLeaf("y");
			systemOrgDao.insert(systemOrg);
		}
		return systemOrg;
	}
    
	/**
	 * 查询数据
	 */
	@Override
	public SystemOrgVo find(String id) {
		SystemOrgVo systemOrgVo=new SystemOrgVo();
		if(!StringUtil.isEmpty(id)){
			SystemOrg org=systemOrgDao.find(Integer.valueOf(id));
			BeanUtils.copyProperties(org, systemOrgVo);
			systemOrgVo.setId(id);
		}
		return systemOrgVo;
	}

	@Override
	public List<SystemOrg> loadOrgTree() {
		 return systemOrgDao.loadOrgTree();
	}

	@Override
	public List<SystemOrg> loadOrgChildrenTree(String fID) {
		 return systemOrgDao.loadOrgChildrenTree(fID);
	}

}
