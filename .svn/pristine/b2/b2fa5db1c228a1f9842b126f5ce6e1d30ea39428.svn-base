package com.xuyurepos.service.impl.payment;

import java.math.BigDecimal;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.Random;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;

import org.apache.log4j.Logger;
import org.springframework.beans.BeanUtils;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import com.xuyurepos.common.constants.SystemConstants;
import com.xuyurepos.common.exception.CustomException;
import com.xuyurepos.common.log.LoggerFactory;
import com.xuyurepos.common.page.PageModel;
import com.xuyurepos.common.util.DateUtil;
import com.xuyurepos.dao.comm.CommonMapper;
import com.xuyurepos.dao.manager.XuyuContentCardInfoDao;
import com.xuyurepos.dao.payment.XuyuRechargeDao;
import com.xuyurepos.entity.manager.XuyuContentCardInfo;
import com.xuyurepos.entity.payment.XuyuRecharge;
import com.xuyurepos.entity.system.SystemUser;
import com.xuyurepos.service.payment.XuyuRechargeService;
import com.xuyurepos.service.system.SystemOrgService;
import com.xuyurepos.vo.payment.XuyuRechargeResultVo;
import com.xuyurepos.vo.payment.XuyuRechargeVo;
import com.xuyurepos.vo.system.SystemOrgVo;
/**
 * 充值处理实现类
 * @author yangfei
 *
 */
@Service
@Transactional
public class XuyuRechargeServiceImpl implements XuyuRechargeService{
	Logger logger=LoggerFactory.getInstance().getLogger(XuyuRechargeServiceImpl.class);
	
	@Resource
	private  XuyuRechargeDao xuyuRechargeDao;
	
	@Resource
	private SystemOrgService systemOrgService;
	
	@Resource
	private XuyuContentCardInfoDao xuyuContentCardInfoDao;
	
	@Resource
	private CommonMapper commonMapper;
    
	/**
	 * 保存方法
	 * @throws CustomException 
	 */
	@Override
	public void saveInfo(XuyuRechargeVo xuyuRechargeVo) throws Exception {
		logger.info(" saveInfo(XuyuRechargeVo xuyuRechargeVo) XuyuRechargeServiceImpl start");
		logger.info("xuyuRechargeVo:"+xuyuRechargeVo.toString());
		if(xuyuRechargeVo.getId()!=null&&!SystemConstants.STRINGEMPTY.equals(xuyuRechargeVo.getId())){
			edit(xuyuRechargeVo);
		}else{
			add(xuyuRechargeVo);
		}
		logger.info(" saveInfo(XuyuRechargeVo xuyuRechargeVo) XuyuRechargeServiceImpl end");
	}
	
	/**
	 * 充值后实际充值操作
	 */
	public void payNotify(String out_trade_no){
		logger.info("充值成功后回调："+out_trade_no);
        try {
    		XuyuRecharge xuyuRecharge=xuyuRechargeDao.find(out_trade_no);
    		if(xuyuRecharge!=null){
    			if(SystemConstants.STRING_YES.equals(xuyuRecharge.getPayCommission())){
    				throw new CustomException("重复处理");
    			}
    			xuyuRecharge.setPayCommission(SystemConstants.STRING_YES);
    			xuyuRechargeDao.update(xuyuRecharge);
    		}else{
    			logger.error("订单号错误："+out_trade_no);
    			throw new CustomException("订单号错误");
    		}
    		XuyuContentCardInfo xuyuContentCardInfo=xuyuContentCardInfoDao.find(xuyuRecharge.getAccessNum());
    		BigDecimal totalGprs=xuyuRecharge.getTotalGprs();
    		// 设置套餐总量
    		// 如果套餐总量为空则直接设置
    		if(xuyuContentCardInfo.getTotalGprs()==null||SystemConstants.STRINGEMPTY.equals(xuyuContentCardInfo.getTotalGprs())){
    			xuyuContentCardInfo.setTotalGprs(totalGprs);
    		}else{
    			// 如果已经存在套餐则需要累加
    			BigDecimal totalGprsNew=xuyuContentCardInfo.getTotalGprs().add(totalGprs);
    			xuyuContentCardInfo.setTotalGprs(totalGprsNew);
    		}
    		String testType=xuyuContentCardInfo.getTestType();
    		String waitType=xuyuContentCardInfo.getWaitType();
    		// 没有测试期和成默契直接计算
    		if(SystemConstants.STRINGEMPTY.equals(testType)
    				   &&SystemConstants.STRINGEMPTY.equals(waitType)){
    			// 如果是多个则需要增加
    			// 重新计算满期日期
                // 判断是否存在满期日
    			if(xuyuContentCardInfo.getDeadlineDate()==null){
    				Date deadlineDate=DateUtil.getLastMonthdate(xuyuContentCardInfo.getActivateDate(),Integer.valueOf(xuyuContentCardInfo.getComboType()));
    				xuyuContentCardInfo.setDeadlineDate(deadlineDate);
    			}else{
    				Date deadlineDate=DateUtil.getLastMonthdate(xuyuContentCardInfo.getDeadlineDate(),Integer.valueOf(xuyuContentCardInfo.getComboType())+1);
    				logger.info("到期时间："+DateUtil.convert(deadlineDate, null));
    				xuyuContentCardInfo.setDeadlineDate(deadlineDate);
    			}
    		}else{
    			// 如果沉默期和测试期存在的情况
    			// 得需要更新的时候计算
    			// 第一步判断测试期有没有结束
    			
    		}
    		xuyuContentCardInfoDao.update(xuyuContentCardInfo);
		} catch (Exception e) {
			logger.error("回调失败："+e.getMessage());
			e.printStackTrace();
		}
		
	}
    
	/**
	 * 修改数据
	 * @param xuyuRechargeVo
	 * @return
	 */
	private XuyuRecharge edit(XuyuRechargeVo xuyuRechargeVo) {
		XuyuRecharge xuyuRecharge=xuyuRechargeDao.find(SystemConstants.STRINGEMPTY+xuyuRechargeVo.getId());
		if(xuyuRecharge!=null){
			BeanUtils.copyProperties(xuyuRechargeVo, xuyuRecharge);
			xuyuRechargeDao.update(xuyuRecharge);
		}
		return xuyuRecharge;
	}
    
	/**
	 * 添加数据
	 * @param xuyuRechargeVo
	 * @return
	 * @throws Exception 
	 */
	@SuppressWarnings({ "rawtypes", "unchecked" })
	private void add(XuyuRechargeVo xuyuRechargeVo) throws Exception {
		try {
			XuyuRecharge xuyuRecharge=null;
			HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
			SystemUser systemUser=(SystemUser) request.getSession().getAttribute("systemUser");
			String orgId=systemUser.getOrgId();
			// 查找机构信息
			SystemOrgVo systemOrgVo=systemOrgService.find(orgId);
			// 判断是否为卡段充值
			if(SystemConstants.STRING_YES.equals(xuyuRechargeVo.getYesNo())){
				if(systemOrgVo.getOrgLevel().equals("1")){
					int result=xuyuContentCardInfoDao.findCount(xuyuRechargeVo.getAccessNumStart(), xuyuRechargeVo.getAccessNumEnd());
					logger.info("result:"+result);
					if(result>100000){
						throw new CustomException("一次充值最多100000张卡");
					}else{
						// 首先判断数据有没有设置套餐
						result=xuyuContentCardInfoDao.findComboType(xuyuRechargeVo.getAccessNumStart(), xuyuRechargeVo.getAccessNumEnd());
						if(result>0){
							throw new CustomException("还未设置套餐，请先设置套餐");
						}
						Calendar calendar = Calendar.getInstance();
						calendar.setTime(new Date());
						xuyuRecharge=new XuyuRecharge();
						xuyuRechargeVo.setIsPay(SystemConstants.STRING_YES);
						xuyuRechargeVo.setCreateUser(systemUser.getUserName());
						xuyuRechargeVo.setCreateOrg(systemUser.getOrgId());
						xuyuRechargeVo.setCreateDate(calendar.getTime());
						HashMap map=new HashMap();
						map.put("record", xuyuRechargeVo);
						xuyuRechargeDao.insertAccs(map);
						// 更新套餐总量
						xuyuContentCardInfoDao.updateTotalGprsAdd(xuyuRechargeVo.getAccessNumStart(), xuyuRechargeVo.getAccessNumEnd(),xuyuRechargeVo.getChargeCost());
						xuyuContentCardInfoDao.updateTotalGprs(xuyuRechargeVo.getAccessNumStart(), xuyuRechargeVo.getAccessNumEnd(),xuyuRechargeVo.getChargeCost());
						// 插入并且更新临时表
						map=new HashMap();
						map.put("accessNumStart", xuyuRechargeVo.getAccessNumStart());
						map.put("accessNumEnd", xuyuRechargeVo.getAccessNumEnd());
						xuyuContentCardInfoDao.truncateTable();
						xuyuContentCardInfoDao.insertInfoOwnerTemp(map);
						// 更新满期日
						xuyuContentCardInfoDao.updateDeadlineDateAdd(xuyuRechargeVo.getAccessNumStart(), xuyuRechargeVo.getAccessNumEnd(),xuyuRechargeVo.getChargeCost());
						xuyuContentCardInfoDao.updateDeadlineDate(xuyuRechargeVo.getAccessNumStart(), xuyuRechargeVo.getAccessNumEnd(),xuyuRechargeVo.getChargeCost());
					}
				}else{
					throw new CustomException("超出当前用户权限，只有总部用户才能充值");
				}
			}else{
				if(systemOrgVo.getOrgLevel().equals("1")){
					String accessNums=xuyuRechargeVo.getAccessNums().replace("\r\n", "");
					if(accessNums!=null&&!SystemConstants.STRINGEMPTY.equals(accessNums)){
						Calendar calendar = Calendar.getInstance();
						calendar.setTime(new Date());
						String[] accessNumStr=accessNums.split(";");
						for (int i = 0; i < accessNumStr.length; i++) {
							XuyuContentCardInfo xuyuContentCardInfo=xuyuContentCardInfoDao.find(accessNumStr[i]);
							xuyuRecharge=new XuyuRecharge();
							xuyuRecharge.setId(createId());
							// 设置后台充值
							BigDecimal money=xuyuContentCardInfo.getUnitCost().multiply(BigDecimal.valueOf(Long.valueOf(xuyuRechargeVo.getChargeCost())));
							if(xuyuContentCardInfo.getComboType()==null||SystemConstants.STRINGEMPTY.equals(xuyuContentCardInfo.getComboType())){
								throw new CustomException("还未设置套餐，请先设置套餐");
							}
							if(xuyuContentCardInfo.getComnoName()==null||SystemConstants.STRINGEMPTY.equals(xuyuContentCardInfo.getComnoName())){
								throw new CustomException("还未设置套餐，请先设置套餐");
							}
							BigDecimal totalGprs=BigDecimal.valueOf(Long.valueOf(xuyuContentCardInfo.getComboType())).multiply(BigDecimal.valueOf(Long.valueOf(xuyuContentCardInfo.getComnoName()))).multiply(BigDecimal.valueOf(Long.valueOf(xuyuRechargeVo.getChargeCost())));
							xuyuRecharge.setAccessNum(xuyuContentCardInfo.getAccessNum());
							xuyuRecharge.setComboType(xuyuContentCardInfo.getComboType());
							xuyuRecharge.setComnoName(xuyuContentCardInfo.getComnoName());
							xuyuRecharge.setTotalGprs(totalGprs);
							xuyuRecharge.setPrice(xuyuContentCardInfo.getUnitCost());
							xuyuRecharge.setMoney(money);
							xuyuRecharge.setIsPay(SystemConstants.STRING_YES);
							xuyuRecharge.setCreateUser(systemUser.getUserName());
							xuyuRecharge.setCreateOrg(systemUser.getOrgId());
							xuyuRecharge.setCreateDate(calendar.getTime());
							xuyuRechargeDao.insert(xuyuRecharge);
							// 设置套餐总量
							// 如果套餐总量为空则直接设置
							if(xuyuContentCardInfo.getTotalGprs()==null||SystemConstants.STRINGEMPTY.equals(xuyuContentCardInfo.getTotalGprs())){
								xuyuContentCardInfo.setTotalGprs(totalGprs);
							}else{
								// 如果已经存在套餐则需要累加
								BigDecimal totalGprsNew=xuyuContentCardInfo.getTotalGprs().add(totalGprs);
								xuyuContentCardInfo.setTotalGprs(totalGprsNew);
							}
							String testType=xuyuContentCardInfo.getTestType();
							String waitType=xuyuContentCardInfo.getWaitType();
							// 没有测试期和成默契直接计算
							if(SystemConstants.STRINGEMPTY.equals(testType)
									   &&SystemConstants.STRINGEMPTY.equals(waitType)){
								// 如果是多个则需要增加
								// 重新计算满期日期
                                // 判断是否存在满期日
								if(xuyuContentCardInfo.getDeadlineDate()==null){
									Date deadlineDate=DateUtil.getLastMonthdate(xuyuContentCardInfo.getActivateDate(), Integer.valueOf(xuyuRechargeVo.getChargeCost())*Integer.valueOf(xuyuContentCardInfo.getComboType()));
									xuyuContentCardInfo.setDeadlineDate(deadlineDate);
								}else{
									Date deadlineDate=DateUtil.getLastMonthdate(xuyuContentCardInfo.getDeadlineDate(), Integer.valueOf(xuyuRechargeVo.getChargeCost())*Integer.valueOf(xuyuContentCardInfo.getComboType())+1);
									logger.info("到期时间："+DateUtil.convert(deadlineDate, null));
									xuyuContentCardInfo.setDeadlineDate(deadlineDate);
								}
							}else{
								// 如果沉默期和测试期存在的情况
								// 得需要更新的时候计算
							}
							xuyuContentCardInfoDao.update(xuyuContentCardInfo);
						}
					}else{
						throw new CustomException("非卡段充值，请选择需要充值的数据");
					}
				}else{
					throw new CustomException("超出当前用户权限，只有总部用户才能充值");
				}
			}
		} catch (Exception e) {
			e.printStackTrace();
			throw e;
		}
	}
    
	/**
	 * 充值记录查询
	 */
	@SuppressWarnings({ "unchecked", "rawtypes" })
	@Override
	public void findList(PageModel pageModel) {
		try {
			pageModel.setRows(xuyuRechargeDao.selectUserListWithPage(pageModel));
		    pageModel.setTotal(xuyuRechargeDao.selectUserCountWithPage(pageModel));
		} catch (Exception e) {
			e.printStackTrace();
		}
		
	}
	
	/**
	 * 生成随机数订单
	 * @return
	 */
	private String createId(){
		String str="0123456789";
    	StringBuilder sb=new StringBuilder(4);
    	for(int i=0;i<3;i++)
    	{
    	char ch=str.charAt(new Random().nextInt(str.length()));
    	sb.append(ch);
    	}
    	
    	SimpleDateFormat sdf=new SimpleDateFormat("yyyyMMddHHmmsssss");
        String out_trade_no = sdf.format(new Date())+sb.toString();
        return out_trade_no;
	}
    
	/**
	 * 创建本地订单表
	 */
	@Override
	public XuyuRechargeResultVo createOrder(XuyuRechargeVo xuyuRechargeVo) {
		XuyuRecharge xuyuRecharge=new XuyuRecharge();
		xuyuRecharge.setId(createId());
		xuyuRecharge.setAccessNum(xuyuRechargeVo.getAccessNum());
		xuyuRecharge.setComboType(xuyuRechargeVo.getComboType());
		xuyuRecharge.setComnoName(xuyuRechargeVo.getComnoName());
		BigDecimal totalGprs=BigDecimal.valueOf(Long.valueOf(xuyuRechargeVo.getComboType())).multiply(BigDecimal.valueOf(Long.valueOf(xuyuRechargeVo.getComnoName())));
		xuyuRecharge.setTotalGprs(totalGprs);
		xuyuRecharge.setPrice(xuyuRechargeVo.getMoney());
		xuyuRecharge.setMoney(xuyuRechargeVo.getMoney());
		xuyuRecharge.setIsPay(SystemConstants.STRING_NO);
		xuyuRecharge.setPayCommission(SystemConstants.STRING_NO);
		Calendar calendar = Calendar.getInstance();
		calendar.setTime(new Date());
		xuyuRecharge.setCreateDate(calendar.getTime());
		xuyuRecharge.setCustomer(xuyuRechargeVo.getCustomer());
		xuyuRechargeDao.createOrder(xuyuRecharge);
		
		XuyuRechargeResultVo xuyuRechargeResultVo=new XuyuRechargeResultVo();
		BeanUtils.copyProperties(xuyuRecharge,xuyuRechargeResultVo);
		return xuyuRechargeResultVo;
	}
    
	/**
	 * 三方支付充值记录
	 * @param pageModel
	 */
	@SuppressWarnings({ "unchecked", "rawtypes" })
	@Override
	public void customerFindList(PageModel pageModel) {
		try {
			pageModel.setRows(xuyuRechargeDao.selectCustomerListWithPage(pageModel));
		    pageModel.setTotal(xuyuRechargeDao.selectCustomerCountWithPage(pageModel));
		} catch (Exception e) {
			e.printStackTrace();
		}
	}
    
	/**
	 * 代理商创建充值订单表
	 * @throws CustomException 
	 */
	@Override
	public XuyuRechargeResultVo createOrder() throws CustomException {
		XuyuRechargeResultVo xuyuRechargeResultVo=null;
		HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
		SystemUser systemUser=(SystemUser) request.getSession().getAttribute("systemUser");
		try {
			String accessNums=request.getParameter("accessNums");
			String money=request.getParameter("money");
			// 查询当前代理商的充值
			StringBuilder sb=new StringBuilder();
			sb.append(" select t1.PRICE from XUYU_CONTENT_CARD_INFO_RECORD t1 where t1.AGENCY='"+systemUser.getOrgId()+"' and t1.ACCESS_NUM='"+accessNums+"' and t1.PRICE is not null ");
			
			Map<String, Object> map=commonMapper.findOneData(sb.toString());
			if(map!=null){
				money=SystemConstants.STRINGEMPTY+map.get("PRICE");
			}else{
				throw new CustomException("获取当前充值金额错误，请联系系统管理员");
			}
			logger.info("金额:"+money);
			XuyuContentCardInfo xuyuContentCardInfo=xuyuContentCardInfoDao.find(accessNums);
			if(xuyuContentCardInfo!=null){
				XuyuRechargeVo xuyuRechargeVo=new XuyuRechargeVo();
				xuyuRechargeVo.setAccessNum(xuyuContentCardInfo.getAccessNum());
				xuyuRechargeVo.setComboType(xuyuContentCardInfo.getComboType());
				xuyuRechargeVo.setComnoName(xuyuContentCardInfo.getComnoName());
				xuyuRechargeVo.setMoney(BigDecimal.valueOf(Double.valueOf(money)));
				xuyuRechargeVo.setCustomer(systemUser.getOrgId());
				xuyuRechargeResultVo=createOrder(xuyuRechargeVo);
			}
		}catch(CustomException e){
			throw e;
		} catch (Exception e) {
			e.printStackTrace();
		}
		return xuyuRechargeResultVo;
	}

}
